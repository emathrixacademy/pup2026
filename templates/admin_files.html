{% extends 'base.html' %}

{% block title %}File Storage - Sangrenes LMS Portal{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1><i class="fas fa-hdd"></i> File Storage Management</h1>
        <p>Manage all uploaded files and documents</p>
    </div>
    <button class="btn btn-primary" onclick="openModal('uploadFileModal')"><i class="fas fa-upload"></i> Upload File</button>
</div>

<!-- Storage Stats -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px;">
    <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.06);text-align:center;border-top:3px solid #3B82F6;">
        <div style="font-size:2rem;font-weight:700;color:#3B82F6;">{{ total_files }}</div>
        <div style="font-size:0.8rem;color:#64748B;">Total Files</div>
    </div>
    <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.06);text-align:center;border-top:3px solid #10B981;">
        <div style="font-size:2rem;font-weight:700;color:#10B981;">{% if total_size > 1048576 %}{{ "%.1f"|format(total_size / 1048576) }} MB{% else %}{{ "%.1f"|format(total_size / 1024) }} KB{% endif %}</div>
        <div style="font-size:0.8rem;color:#64748B;">Total Storage</div>
    </div>
    <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.06);text-align:center;border-top:3px solid #8B5CF6;">
        <div style="font-size:2rem;font-weight:700;color:#8B5CF6;">{{ total_categories }}</div>
        <div style="font-size:0.8rem;color:#64748B;">Categories</div>
    </div>
</div>

<!-- Files Table -->
<div style="background:white;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06);overflow:hidden;">
    <div style="padding:16px 20px;border-bottom:1px solid #E2E8F0;display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0;font-size:1rem;"><i class="fas fa-folder-open" style="color:#F59E0B;"></i> All Files</h3>
        <input type="text" id="fileSearch" placeholder="Search files..." onkeyup="filterFiles()" style="padding:6px 14px;border:1px solid #E2E8F0;border-radius:8px;font-size:0.85rem;">
    </div>
    {% if files %}
    <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;" id="filesTable">
            <thead>
                <tr style="background:#F8FAFC;">
                    <th style="padding:10px 14px;text-align:left;font-size:0.8rem;color:#64748B;">File</th>
                    <th style="padding:10px 14px;text-align:center;font-size:0.8rem;color:#64748B;">Type</th>
                    <th style="padding:10px 14px;text-align:center;font-size:0.8rem;color:#64748B;">Category</th>
                    <th style="padding:10px 14px;text-align:center;font-size:0.8rem;color:#64748B;">Subject</th>
                    <th style="padding:10px 14px;text-align:center;font-size:0.8rem;color:#64748B;">Uploader</th>
                    <th style="padding:10px 14px;text-align:center;font-size:0.8rem;color:#64748B;">Size</th>
                    <th style="padding:10px 14px;text-align:center;font-size:0.8rem;color:#64748B;">Downloads</th>
                    <th style="padding:10px 14px;text-align:center;font-size:0.8rem;color:#64748B;">Public</th>
                    <th style="padding:10px 14px;text-align:right;font-size:0.8rem;color:#64748B;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for f in files %}
                <tr style="border-bottom:1px solid #F1F5F9;" class="file-row" data-name="{{ f.original_name|lower }}">
                    <td style="padding:10px 14px;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <i class="fas fa-{% if f.file_type in ('pdf',) %}file-pdf{% elif f.file_type in ('doc','docx') %}file-word{% elif f.file_type in ('ppt','pptx') %}file-powerpoint{% elif f.file_type in ('xls','xlsx') %}file-excel{% elif f.file_type in ('jpg','jpeg','png','gif') %}file-image{% elif f.file_type in ('mp4','avi','mov') %}file-video{% elif f.file_type in ('py','js','html','css') %}file-code{% elif f.file_type in ('zip','rar','7z') %}file-archive{% else %}file-alt{% endif %}" style="color:#3B82F6;font-size:1.3rem;"></i>
                            <div>
                                <div style="font-weight:600;font-size:0.85rem;">{{ f.original_name }}</div>
                                <div style="font-size:0.7rem;color:#94A3B8;">{{ f.created_at[:16] if f.created_at else '' }}</div>
                            </div>
                        </div>
                    </td>
                    <td style="padding:10px 14px;text-align:center;"><span style="background:#F1F5F9;padding:2px 8px;border-radius:6px;font-size:0.75rem;color:#64748B;">.{{ f.file_type }}</span></td>
                    <td style="padding:10px 14px;text-align:center;"><span style="background:#EDE9FE;color:#7C3AED;padding:2px 10px;border-radius:12px;font-size:0.75rem;">{{ f.category }}</span></td>
                    <td style="padding:10px 14px;text-align:center;font-size:0.85rem;">{{ f.subject_code or '-' }}</td>
                    <td style="padding:10px 14px;text-align:center;font-size:0.85rem;color:#64748B;">{{ f.uploader_name or '-' }}</td>
                    <td style="padding:10px 14px;text-align:center;font-size:0.85rem;color:#64748B;">{% if f.file_size > 1048576 %}{{ "%.1f"|format(f.file_size / 1048576) }} MB{% else %}{{ "%.1f"|format((f.file_size or 0) / 1024) }} KB{% endif %}</td>
                    <td style="padding:10px 14px;text-align:center;font-size:0.85rem;font-weight:600;color:#3B82F6;">{{ f.download_count }}</td>
                    <td style="padding:10px 14px;text-align:center;">{% if f.is_public %}<i class="fas fa-globe" style="color:#10B981;"></i>{% else %}<i class="fas fa-lock" style="color:#94A3B8;"></i>{% endif %}</td>
                    <td style="padding:10px 14px;text-align:right;">
                        <a href="/admin/files/download/{{ f.id }}" style="padding:4px 10px;font-size:0.75rem;background:#DBEAFE;color:#1E40AF;border:none;border-radius:6px;text-decoration:none;margin-right:4px;"><i class="fas fa-download"></i></a>
                        <button onclick="deleteFile({{ f.id }})" style="padding:4px 10px;font-size:0.75rem;background:#FEE2E2;color:#991B1B;border:none;border-radius:6px;cursor:pointer;"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="padding:60px;text-align:center;color:#94A3B8;">
        <i class="fas fa-cloud-upload-alt" style="font-size:3rem;margin-bottom:16px;color:#CBD5E1;"></i>
        <h3 style="color:#64748B;">No files uploaded yet</h3>
        <p>Upload documents, materials, and resources.</p>
    </div>
    {% endif %}
</div>

<!-- Upload File Modal -->
<div id="uploadFileModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;">
    <div style="background:white;border-radius:16px;padding:30px;max-width:450px;width:90%;margin:auto;position:relative;top:50%;transform:translateY(-50%);">
        <h3 style="margin:0 0 20px;"><i class="fas fa-upload" style="color:#3B82F6;"></i> Upload File</h3>
        <form id="uploadForm" enctype="multipart/form-data">
            <div style="display:flex;flex-direction:column;gap:12px;">
                <div><label style="font-size:0.8rem;color:#64748B;">File *</label><input type="file" name="file" required style="padding:10px;border:1px solid #E2E8F0;border-radius:8px;width:100%;box-sizing:border-box;"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                    <div><label style="font-size:0.8rem;color:#64748B;">Category</label>
                        <select name="category" style="padding:10px;border:1px solid #E2E8F0;border-radius:8px;width:100%;">
                            <option value="general">General</option>
                            <option value="lecture">Lecture</option>
                            <option value="lab">Lab Material</option>
                            <option value="reference">Reference</option>
                            <option value="syllabus">Syllabus</option>
                            <option value="template">Template</option>
                            <option value="form">Form</option>
                            <option value="report">Report</option>
                        </select>
                    </div>
                    <div><label style="font-size:0.8rem;color:#64748B;">Subject</label>
                        <select name="subject_id" style="padding:10px;border:1px solid #E2E8F0;border-radius:8px;width:100%;">
                            <option value="">-- General --</option>
                            {% for s in subjects %}<option value="{{ s.id }}">{{ s.code }} ({{ s.section }})</option>{% endfor %}
                        </select>
                    </div>
                </div>
                <div><label style="font-size:0.8rem;color:#64748B;">Description</label><input type="text" name="description" style="padding:10px;border:1px solid #E2E8F0;border-radius:8px;width:100%;box-sizing:border-box;"></div>
                <label style="font-size:0.85rem;color:#64748B;"><input type="checkbox" name="is_public" value="1"> Public access</label>
            </div>
            <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end;">
                <button type="button" onclick="closeModal('uploadFileModal')" style="padding:8px 20px;border:1px solid #E2E8F0;border-radius:8px;background:white;cursor:pointer;">Cancel</button>
                <button type="submit" style="padding:8px 20px;border:none;border-radius:8px;background:#3B82F6;color:white;cursor:pointer;font-weight:600;">Upload</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function filterFiles() {
    const q = document.getElementById('fileSearch').value.toLowerCase();
    document.querySelectorAll('.file-row').forEach(r => {
        r.style.display = r.dataset.name.includes(q) ? '' : 'none';
    });
}
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch('/api/admin/materials/upload', { method: 'POST', body: formData })
        .then(r => r.json()).then(d => { if (d.success) location.reload(); else alert(d.error || 'Upload failed'); });
});
function deleteFile(id) {
    if (!confirm('Delete this file permanently?')) return;
    fetch(`/api/admin/materials/${id}`, { method: 'DELETE' })
        .then(r => r.json()).then(d => { if (d.success) location.reload(); });
}
</script>
{% endblock %}
