{% extends 'base.html' %}
{% block title %}Subjects - Sangrenes LMS{% endblock %}
{% block content %}
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
    <h1 style="font-size:1.2rem;font-weight:700;margin:0;"><i class="fas fa-book-open" style="color:#F59E0B;"></i> Subjects</h1>
    <button onclick="document.getElementById('editSubjectId').value='';openModal('addSubjectModal')" style="padding:8px 16px;border:none;border-radius:8px;background:var(--primary);color:white;font-size:0.82rem;font-weight:600;cursor:pointer;"><i class="fas fa-plus"></i> Add Subject</button>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;">
    {% set colors = ['#6366F1','#10B981','#8B5CF6','#F59E0B','#EF4444','#3B82F6'] %}
    {% for s in subjects %}
    <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;">
        <div style="background:{{ colors[loop.index0 % 6] }};padding:16px 18px;color:white;">
            <div style="font-size:1.05rem;font-weight:700;">{{ s.code }}</div>
            <div style="font-size:0.82rem;opacity:0.9;">{{ s.name }}</div>
            <div style="font-size:0.72rem;opacity:0.8;margin-top:4px;">{{ s.section }} &middot; {{ s.day or '' }} {{ s.time_schedule or '' }}</div>
        </div>
        <div style="padding:14px 18px;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:0.78rem;color:var(--muted);margin-bottom:10px;">
                <div><i class="fas fa-user-tie" style="width:16px;"></i> {{ s.instructor_name or 'Unassigned' }}</div>
                <div><i class="fas fa-users" style="width:16px;"></i> {{ s.enrolled }} enrolled</div>
                {% if s.room %}<div><i class="fas fa-door-open" style="width:16px;"></i> {{ s.room }}</div>{% endif %}
                <div><i class="fas fa-book" style="width:16px;"></i> {{ s.session_count }} sessions</div>
            </div>
            <div style="display:flex;gap:6px;">
                <button onclick='editSubject({{ s|tojson }})' style="padding:5px 12px;font-size:0.72rem;background:#DBEAFE;color:#1E40AF;border:none;border-radius:6px;cursor:pointer;"><i class="fas fa-edit"></i> Edit</button>
                <button onclick="deleteSubject({{ s.id }})" style="padding:5px 12px;font-size:0.72rem;background:#FEE2E2;color:#991B1B;border:none;border-radius:6px;cursor:pointer;"><i class="fas fa-trash"></i></button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Add/Edit Subject Modal -->
<div id="addSubjectModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;">
    <div style="background:white;border-radius:16px;padding:30px;max-width:550px;width:90%;margin:auto;position:relative;top:50%;transform:translateY(-50%);">
        <h3 style="margin:0 0 20px;" id="subjectModalTitle"><i class="fas fa-plus-circle" style="color:#F59E0B;"></i> Add Subject</h3>
        <input type="hidden" id="editSubjectId">
        <div style="display:flex;flex-direction:column;gap:12px;">
            <div style="display:grid;grid-template-columns:1fr 2fr;gap:10px;">
                <div><label style="font-size:0.8rem;color:var(--muted);">Code *</label><input type="text" id="subCode" placeholder="e.g. COMP019" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;box-sizing:border-box;"></div>
                <div><label style="font-size:0.8rem;color:var(--muted);">Name *</label><input type="text" id="subName" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;box-sizing:border-box;"></div>
            </div>
            <div><label style="font-size:0.8rem;color:var(--muted);">Description</label><input type="text" id="subDesc" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;box-sizing:border-box;"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label style="font-size:0.8rem;color:var(--muted);">Section</label><input type="text" id="subSection" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;box-sizing:border-box;"></div>
                <div><label style="font-size:0.8rem;color:var(--muted);">Assign Teacher</label>
                    <select id="subInstructor" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;">
                        <option value="">-- None --</option>
                        {% for t in teachers %}<option value="{{ t.id }}">{{ t.full_name }}</option>{% endfor %}
                    </select></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
                <div><label style="font-size:0.8rem;color:var(--muted);">Day</label>
                    <select id="subDay" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;">
                        <option value="">--</option>
                        <option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option>
                    </select></div>
                <div><label style="font-size:0.8rem;color:var(--muted);">Time</label><input type="text" id="subTime" placeholder="e.g. 1:00PM-6:00PM" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;box-sizing:border-box;"></div>
                <div><label style="font-size:0.8rem;color:var(--muted);">Room</label><input type="text" id="subRoom" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;box-sizing:border-box;"></div>
            </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end;">
            <button onclick="closeModal('addSubjectModal')" style="padding:8px 20px;border:1px solid var(--border);border-radius:8px;background:white;cursor:pointer;">Cancel</button>
            <button onclick="saveSubject()" style="padding:8px 20px;border:none;border-radius:8px;background:var(--primary);color:white;cursor:pointer;font-weight:600;">Save</button>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
function editSubject(s) {
    document.getElementById('editSubjectId').value = s.id;
    document.getElementById('subjectModalTitle').innerHTML = '<i class="fas fa-edit" style="color:#F59E0B;"></i> Edit Subject';
    document.getElementById('subCode').value = s.code || '';
    document.getElementById('subName').value = s.name || '';
    document.getElementById('subDesc').value = s.description || '';
    document.getElementById('subSection').value = s.section || '';
    document.getElementById('subInstructor').value = s.instructor_id || '';
    document.getElementById('subDay').value = s.day || '';
    document.getElementById('subTime').value = s.time_schedule || '';
    document.getElementById('subRoom').value = s.room || '';
    openModal('addSubjectModal');
}
function saveSubject() {
    const id = document.getElementById('editSubjectId').value;
    const data = {
        code: document.getElementById('subCode').value,
        name: document.getElementById('subName').value,
        description: document.getElementById('subDesc').value,
        section: document.getElementById('subSection').value,
        instructor_id: document.getElementById('subInstructor').value || null,
        day: document.getElementById('subDay').value,
        time_schedule: document.getElementById('subTime').value,
        room: document.getElementById('subRoom').value
    };
    const url = id ? `/api/institution/subjects/${id}` : '/api/institution/subjects';
    fetch(url, { method: id ? 'PUT' : 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) })
        .then(r => r.json()).then(d => { if (d.success) location.reload(); else alert(d.error || 'Failed'); });
}
function deleteSubject(id) {
    if (!confirm('Delete this subject and all its sessions?')) return;
    fetch(`/api/institution/subjects/${id}`, { method: 'DELETE' })
        .then(r => r.json()).then(d => { if (d.success) location.reload(); });
}
</script>
{% endblock %}
