{% extends 'base.html' %}

{% block title %}Platform Admin Dashboard - Sangrenes LMS Portal{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1><i class="fas fa-tachometer-alt"></i> Platform Admin Dashboard</h1>
        <p>AI-Powered Management Hub</p>
    </div>
</div>

<!-- Stats Grid -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px;">
    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-left: 4px solid #8B5CF6;">
        <div style="font-size: 2rem; font-weight: 700; color: #8B5CF6;">{{ total_institutions }}</div>
        <div style="font-size: 0.85rem; color: #64748B;"><i class="fas fa-university"></i> Institutions</div>
    </div>
    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-left: 4px solid #3B82F6;">
        <div style="font-size: 2rem; font-weight: 700; color: #3B82F6;">{{ total_instructors }}</div>
        <div style="font-size: 0.85rem; color: #64748B;"><i class="fas fa-chalkboard-teacher"></i> Instructors</div>
    </div>
    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-left: 4px solid #10B981;">
        <div style="font-size: 2rem; font-weight: 700; color: #10B981;">{{ total_students }}</div>
        <div style="font-size: 0.85rem; color: #64748B;"><i class="fas fa-users"></i> Students</div>
    </div>
    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-left: 4px solid #F59E0B;">
        <div style="font-size: 2rem; font-weight: 700; color: #F59E0B;">{{ total_subjects }}</div>
        <div style="font-size: 0.85rem; color: #64748B;"><i class="fas fa-book"></i> Subjects</div>
    </div>
    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-left: 4px solid #06B6D4;">
        <div style="font-size: 2rem; font-weight: 700; color: #06B6D4;">{{ total_ai_actions }}</div>
        <div style="font-size: 0.85rem; color: #64748B;"><i class="fas fa-robot"></i> AI Actions</div>
    </div>
    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-left: 4px solid #EF4444;">
        <div style="font-size: 2rem; font-weight: 700; color: #EF4444;">{{ pending_payroll }}</div>
        <div style="font-size: 0.85rem; color: #64748B;"><i class="fas fa-money-check-alt"></i> Pending Payroll</div>
    </div>
</div>

<!-- Two Column Layout -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 24px;">
    <!-- Recent AI Activity -->
    <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); overflow: hidden;">
        <div style="padding: 16px 20px; border-bottom: 1px solid #E2E8F0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 1rem;"><i class="fas fa-robot" style="color: #8B5CF6;"></i> Recent AI Activity</h3>
            <a href="{{ url_for('admin_ai_logs') }}" style="font-size: 0.8rem; color: #3B82F6; text-decoration: none;">View All</a>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
            {% if recent_ai_logs %}
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #F8FAFC;">
                        <th style="padding: 8px 12px; text-align: left; font-size: 0.75rem; color: #64748B;">Time</th>
                        <th style="padding: 8px 12px; text-align: left; font-size: 0.75rem; color: #64748B;">Action</th>
                        <th style="padding: 8px 12px; text-align: left; font-size: 0.75rem; color: #64748B;">Decision</th>
                        <th style="padding: 8px 12px; text-align: center; font-size: 0.75rem; color: #64748B;">Severity</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in recent_ai_logs %}
                    <tr style="border-bottom: 1px solid #F1F5F9;">
                        <td style="padding: 8px 12px; font-size: 0.8rem; color: #64748B; white-space: nowrap;">{{ log.created_at[:16] }}</td>
                        <td style="padding: 8px 12px;"><span style="background: #EDE9FE; color: #7C3AED; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">{{ log.action_type }}</span></td>
                        <td style="padding: 8px 12px; font-size: 0.8rem; color: #334155; max-width: 250px; overflow: hidden; text-overflow: ellipsis;">{{ log.decision }}</td>
                        <td style="padding: 8px 12px; text-align: center;">
                            {% if log.severity == 'critical' %}
                            <span style="background: #FEE2E2; color: #DC2626; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem;">critical</span>
                            {% elif log.severity == 'warning' %}
                            <span style="background: #FEF3C7; color: #D97706; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem;">warning</span>
                            {% else %}
                            <span style="background: #DBEAFE; color: #2563EB; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem;">info</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div style="padding: 40px; text-align: center; color: #94A3B8;">
                <i class="fas fa-robot" style="font-size: 2rem; margin-bottom: 8px;"></i>
                <p>No AI actions yet. The AI Admin agent runs every 30 minutes.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Quick Actions -->
    <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 20px;">
        <h3 style="margin: 0 0 16px; font-size: 1rem;"><i class="fas fa-bolt" style="color: #F59E0B;"></i> Quick Actions</h3>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <a href="{{ url_for('admin_institutions') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #F8FAFC; border-radius: 8px; text-decoration: none; color: #334155; transition: background 0.2s;" onmouseover="this.style.background='#EDE9FE'" onmouseout="this.style.background='#F8FAFC'">
                <i class="fas fa-university" style="color: #8B5CF6; width: 20px;"></i> Manage Institutions
            </a>
            <a href="{{ url_for('admin_instructors') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #F8FAFC; border-radius: 8px; text-decoration: none; color: #334155;" onmouseover="this.style.background='#DBEAFE'" onmouseout="this.style.background='#F8FAFC'">
                <i class="fas fa-chalkboard-teacher" style="color: #3B82F6; width: 20px;"></i> Manage Instructors
            </a>
            <a href="{{ url_for('admin_payroll') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #F8FAFC; border-radius: 8px; text-decoration: none; color: #334155;" onmouseover="this.style.background='#D1FAE5'" onmouseout="this.style.background='#F8FAFC'">
                <i class="fas fa-money-check-alt" style="color: #10B981; width: 20px;"></i> Payroll Management
            </a>
            <a href="{{ url_for('admin_ai_rules') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #F8FAFC; border-radius: 8px; text-decoration: none; color: #334155;" onmouseover="this.style.background='#FEF3C7'" onmouseout="this.style.background='#F8FAFC'">
                <i class="fas fa-cogs" style="color: #F59E0B; width: 20px;"></i> AI Rules Config
            </a>
            <a href="{{ url_for('admin_ai_logs') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #F8FAFC; border-radius: 8px; text-decoration: none; color: #334155;" onmouseover="this.style.background='#CFFAFE'" onmouseout="this.style.background='#F8FAFC'">
                <i class="fas fa-robot" style="color: #06B6D4; width: 20px;"></i> AI Activity Logs
            </a>
        </div>
        <div style="margin-top: 20px; padding: 12px; background: #F0FDF4; border-radius: 8px; border: 1px solid #BBF7D0;">
            <div style="font-size: 0.8rem; font-weight: 600; color: #166534;"><i class="fas fa-check-circle"></i> AI Admin Agent</div>
            <div style="font-size: 0.75rem; color: #15803D; margin-top: 4px;">{{ active_rules }} active rules monitoring your platform</div>
        </div>
        <div style="margin-top: 10px; padding: 12px; background: #EFF6FF; border-radius: 8px; border: 1px solid #BFDBFE;">
            <div style="font-size: 0.8rem; font-weight: 600; color: #1E40AF;"><i class="fas fa-wallet"></i> Total Paid</div>
            <div style="font-size: 1.2rem; font-weight: 700; color: #1E40AF; margin-top: 4px;">&#8369;{{ "{:,.2f}".format(total_paid) }}</div>
        </div>
    </div>
</div>

<!-- Institutions Overview -->
<div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); overflow: hidden;">
    <div style="padding: 16px 20px; border-bottom: 1px solid #E2E8F0;">
        <h3 style="margin: 0; font-size: 1rem;"><i class="fas fa-university" style="color: #8B5CF6;"></i> Institutions Overview</h3>
    </div>
    {% if institutions %}
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #F8FAFC;">
                <th style="padding: 10px 16px; text-align: left; font-size: 0.8rem; color: #64748B;">Institution</th>
                <th style="padding: 10px 16px; text-align: center; font-size: 0.8rem; color: #64748B;">Plan</th>
                <th style="padding: 10px 16px; text-align: center; font-size: 0.8rem; color: #64748B;">Status</th>
                <th style="padding: 10px 16px; text-align: right; font-size: 0.8rem; color: #64748B;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for inst in institutions %}
            <tr style="border-bottom: 1px solid #F1F5F9;">
                <td style="padding: 12px 16px;">
                    <div style="font-weight: 600; color: #1E293B;">{{ inst.name }}</div>
                    <div style="font-size: 0.8rem; color: #64748B;">{{ inst.short_name or '' }} &middot; {{ inst.domain or 'No domain' }}</div>
                </td>
                <td style="padding: 12px 16px; text-align: center;">
                    <span style="background: #EDE9FE; color: #7C3AED; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">{{ inst.plan }}</span>
                </td>
                <td style="padding: 12px 16px; text-align: center;">
                    {% if inst.is_active %}
                    <span style="background: #D1FAE5; color: #065F46; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem;">Active</span>
                    {% else %}
                    <span style="background: #FEE2E2; color: #991B1B; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem;">Inactive</span>
                    {% endif %}
                </td>
                <td style="padding: 12px 16px; text-align: right;">
                    <a href="{{ url_for('admin_institutions') }}" style="color: #3B82F6; font-size: 0.8rem;">Manage</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="padding: 40px; text-align: center; color: #94A3B8;">
        <i class="fas fa-university" style="font-size: 2rem; margin-bottom: 8px;"></i>
        <p>No institutions registered yet.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
