{% extends 'base.html' %}

{% block title %}{{ exam.title }} - Classroom LMS{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>{{ exam.title }}</h1>
        <p class="section-info">{{ exam.subject_code }} - {{ exam.exam_type|capitalize }} Exam</p>
    </div>
    <a href="{{ url_for('subject_exams', subject_id=exam.subject_id) }}" class="btn btn-secondary">Back to Exams</a>
</div>

<div class="exam-container">
    <!-- Exam Header -->
    <div class="exam-header">
        <h2>{{ exam.exam_type|capitalize }} Examination</h2>
        <div class="exam-meta">
            <span class="exam-info">{{ questions|length }} Questions</span>
            <span class="exam-info">{{ exam.total_points }} Points</span>
            {% if exam.time_limit > 0 %}
            <span class="exam-info time-limit">Time: {{ exam.time_limit }} minutes</span>
            {% endif %}
        </div>
    </div>

    <!-- Exam Instructions -->
    <div class="exam-instructions">
        <p><strong>Instructions:</strong> Read each question carefully. For multiple choice, select the best answer. For fill-in-the-blank, provide the correct term.</p>
    </div>

    <!-- Questions by Type -->
    {% set mc_questions = [] %}
    {% set tf_questions = [] %}
    {% set sa_questions = [] %}

    {% for q in questions %}
        {% if q.question_type == 'multiple_choice' %}
            {% set _ = mc_questions.append(q) %}
        {% elif q.question_type == 'true_false' %}
            {% set _ = tf_questions.append(q) %}
        {% else %}
            {% set _ = sa_questions.append(q) %}
        {% endif %}
    {% endfor %}

    <!-- Multiple Choice Section -->
    {% if mc_questions|length > 0 %}
    <div class="question-section">
        <h3 class="section-title">Part I: Multiple Choice ({{ mc_questions|length }} items)</h3>
        <div class="exam-questions">
            {% for q in mc_questions %}
            <div class="exam-question">
                <div class="question-number">{{ loop.index }}</div>
                <div class="question-content">
                    <p class="question-text">{{ q.question_text }}</p>
                    <div class="options-grid">
                        {% set options = q.options | parse_json if q.options else [] %}
                        {% for option in options %}
                        <label class="option-label {% if ['A', 'B', 'C', 'D'][loop.index0] == q.correct_answer %}correct-answer{% endif %}">
                            <span class="option-letter">{{ ['A', 'B', 'C', 'D'][loop.index0] }}</span>
                            <span class="option-text">{{ option }}</span>
                            {% if ['A', 'B', 'C', 'D'][loop.index0] == q.correct_answer %}
                            <span class="correct-badge">Correct</span>
                            {% endif %}
                        </label>
                        {% endfor %}
                    </div>
                    <div class="question-meta">
                        <span class="points-badge">{{ q.points }} pt{% if q.points > 1 %}s{% endif %}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- True/False Section -->
    {% if tf_questions|length > 0 %}
    <div class="question-section">
        <h3 class="section-title">Part II: True or False ({{ tf_questions|length }} items)</h3>
        <div class="exam-questions">
            {% for q in tf_questions %}
            <div class="exam-question">
                <div class="question-number tf">{{ loop.index + mc_questions|length }}</div>
                <div class="question-content">
                    <p class="question-text">{{ q.question_text }}</p>
                    <div class="options-grid tf-options">
                        <label class="option-label {% if q.correct_answer == 'TRUE' %}correct-answer{% endif %}">
                            <span class="option-letter">T</span>
                            <span class="option-text">TRUE</span>
                            {% if q.correct_answer == 'TRUE' %}
                            <span class="correct-badge">Correct</span>
                            {% endif %}
                        </label>
                        <label class="option-label {% if q.correct_answer == 'FALSE' %}correct-answer{% endif %}">
                            <span class="option-letter">F</span>
                            <span class="option-text">FALSE</span>
                            {% if q.correct_answer == 'FALSE' %}
                            <span class="correct-badge">Correct</span>
                            {% endif %}
                        </label>
                    </div>
                    <div class="question-meta">
                        <span class="points-badge">{{ q.points }} pt{% if q.points > 1 %}s{% endif %}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Short Answer / Fill in the Blank Section -->
    {% if sa_questions|length > 0 %}
    <div class="question-section">
        <h3 class="section-title">Part III: Fill in the Blank / Matching ({{ sa_questions|length }} items)</h3>
        <div class="exam-questions">
            {% for q in sa_questions %}
            <div class="exam-question">
                <div class="question-number sa">{{ loop.index + mc_questions|length + tf_questions|length }}</div>
                <div class="question-content">
                    <p class="question-text">{{ q.question_text }}</p>
                    <div class="answer-display">
                        <span class="answer-label">Answer:</span>
                        <span class="answer-value">{{ q.correct_answer }}</span>
                    </div>
                    <div class="question-meta">
                        <span class="points-badge">{{ q.points }} pt{% if q.points > 1 %}s{% endif %}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Answer Key Summary (Instructor Only) -->
    {% if current_user.role == 'instructor' %}
    <div class="answer-key-section">
        <h3 class="answer-key-title">ANSWER KEY SUMMARY</h3>
        <div class="answer-key-grid">
            <table class="answer-key-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Answer</th>
                        <th>Type</th>
                    </tr>
                </thead>
                <tbody>
                    {% for q in questions %}
                    <tr>
                        <td class="q-num">{{ loop.index }}</td>
                        <td class="q-answer">{{ q.correct_answer }}</td>
                        <td class="q-type">{{ q.question_type|replace('_', ' ')|title }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Question Form (Instructor Only) -->
    <div class="card mt-30">
        <div class="card-header">
            <span class="card-title">Add New Question</span>
        </div>
        <form action="{{ url_for('add_exam_question', exam_id=exam.id) }}" method="POST" class="add-question-form">
            <div class="form-group">
                <label>Question Text</label>
                <textarea name="question_text" rows="2" required></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Question Type</label>
                    <select name="question_type" id="examQuestionType" onchange="toggleExamOptionsField()">
                        <option value="multiple_choice">Multiple Choice</option>
                        <option value="true_false">True/False</option>
                        <option value="short_answer">Short Answer / Fill-in-the-Blank</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Points</label>
                    <input type="number" name="points" value="1" min="1">
                </div>
            </div>
            <div class="form-group" id="examOptionsGroup">
                <label>Options (one per line for Multiple Choice)</label>
                <textarea name="options" rows="4" placeholder="Option A&#10;Option B&#10;Option C&#10;Option D"></textarea>
            </div>
            <div class="form-group">
                <label>Correct Answer (A, B, C, D for MC; TRUE/FALSE for T/F; exact text for short answer)</label>
                <input type="text" name="correct_answer" required placeholder="e.g., B or TRUE">
            </div>
            <button type="submit" class="btn btn-emerald">Add Question</button>
        </form>
    </div>
    {% endif %}
</div>

<style>
.exam-container {
    max-width: 950px;
    margin: 0 auto;
}

.exam-header {
    background: linear-gradient(135deg, #10B981, #059669);
    color: white;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 20px;
}

.exam-header h2 {
    margin: 0 0 15px 0;
    font-size: 1.5rem;
}

.exam-meta {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.exam-info {
    background: rgba(255,255,255,0.2);
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.9rem;
}

.time-limit {
    background: #EF4444;
}

.exam-instructions {
    background: #ECFDF5;
    border-left: 4px solid #10B981;
    padding: 15px 20px;
    margin-bottom: 25px;
    border-radius: 0 8px 8px 0;
}

.exam-instructions p {
    margin: 0;
    color: #047857;
}

.question-section {
    margin-bottom: 30px;
}

.section-title {
    background: #F0FDF4;
    color: #047857;
    padding: 12px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #10B981;
}

.exam-questions {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.exam-question {
    background: white;
    border: 1px solid #E5E7EB;
    border-radius: 12px;
    padding: 20px;
    display: flex;
    gap: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.question-number {
    background: #10B981;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1rem;
    flex-shrink: 0;
}

.question-number.tf {
    background: #F59E0B;
}

.question-number.sa {
    background: #3B82F6;
}

.question-content {
    flex: 1;
}

.question-text {
    font-size: 1rem;
    color: #1F2937;
    margin-bottom: 15px;
    line-height: 1.5;
}

.options-grid {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.option-label {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 15px;
    background: #F9FAFB;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    transition: all 0.2s;
}

.option-label.correct-answer {
    background: #ECFDF5;
    border-color: #10B981;
}

.option-letter {
    background: #6B7280;
    color: white;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.85rem;
}

.correct-answer .option-letter {
    background: #10B981;
}

.option-text {
    color: #374151;
    font-size: 0.95rem;
    flex: 1;
}

.correct-badge {
    background: #10B981;
    color: white;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.tf-options {
    flex-direction: row;
    gap: 15px;
}

.tf-options .option-label {
    flex: 1;
    justify-content: center;
}

.answer-display {
    background: #F0FDF4;
    padding: 12px 16px;
    border-radius: 8px;
    border: 2px solid #10B981;
}

.answer-label {
    color: #047857;
    font-weight: 600;
    margin-right: 10px;
}

.answer-value {
    color: #059669;
    font-weight: bold;
    font-size: 1.1rem;
}

.question-meta {
    margin-top: 10px;
    display: flex;
    justify-content: flex-end;
}

.points-badge {
    background: #E5E7EB;
    color: #6B7280;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
}

/* Answer Key Styles */
.answer-key-section {
    margin-top: 40px;
    background: #F0FDF4;
    border: 2px solid #10B981;
    border-radius: 12px;
    padding: 25px;
}

.answer-key-title {
    color: #059669;
    margin: 0 0 20px 0;
    text-align: center;
    font-size: 1.3rem;
    letter-spacing: 2px;
}

.answer-key-grid {
    max-height: 400px;
    overflow-y: auto;
}

.answer-key-table {
    width: 100%;
    border-collapse: collapse;
}

.answer-key-table th {
    background: #10B981;
    color: white;
    padding: 10px 15px;
    text-align: left;
    font-weight: 600;
    position: sticky;
    top: 0;
}

.answer-key-table th:first-child {
    border-radius: 8px 0 0 0;
    width: 60px;
    text-align: center;
}

.answer-key-table th:nth-child(2) {
    width: 120px;
    text-align: center;
}

.answer-key-table th:last-child {
    border-radius: 0 8px 0 0;
}

.answer-key-table td {
    padding: 10px 15px;
    border-bottom: 1px solid #D1FAE5;
}

.answer-key-table tr:last-child td {
    border-bottom: none;
}

.answer-key-table tr:nth-child(even) {
    background: #ECFDF5;
}

.q-num {
    text-align: center;
    font-weight: 600;
    color: #059669;
}

.q-answer {
    text-align: center;
    font-weight: bold;
    color: #059669;
    font-size: 1rem;
}

.q-type {
    color: #6B7280;
    font-size: 0.85rem;
}

.mt-30 {
    margin-top: 30px;
}

.form-row {
    display: flex;
    gap: 20px;
}

.form-row .form-group {
    flex: 1;
}

.add-question-form {
    padding: 20px;
}

.section-info {
    color: #6B7280;
    font-size: 0.95rem;
    margin-top: 5px;
}

.btn-emerald {
    background: #10B981;
    color: white;
}

.btn-emerald:hover {
    background: #059669;
}
</style>

<script>
function toggleExamOptionsField() {
    const type = document.getElementById('examQuestionType').value;
    const optionsGroup = document.getElementById('examOptionsGroup');
    if (type === 'short_answer' || type === 'true_false') {
        optionsGroup.style.display = 'none';
    } else {
        optionsGroup.style.display = 'block';
    }
}
</script>
{% endblock %}
