{% extends 'base.html' %}

{% block title %}Reading Materials - Session {{ session.session_number }}{% endblock %}

{% block content %}
<div style="max-width: 1100px; margin: 0 auto; padding: 0 20px;">

    <!-- Back Navigation -->
    <div style="margin-bottom: 1rem;">
        <a href="{{ url_for('session_lesson', session_id=session.id) }}" class="btn btn-secondary btn-sm">
            <i class="fas fa-arrow-left"></i> Back to Lesson
        </a>
    </div>

    <!-- Progress Stepper -->
    {% if current_user.role == 'student' and progress %}
    {% include 'includes/progress_stepper.html' %}
    {% endif %}

    <!-- Podcast Audio Player -->
    {% if session.reading_materials %}
    <div class="podcast-player" id="podcastPlayer">
        <div class="podcast-header">
            <div class="podcast-icon">
                <i class="fas fa-headphones-alt"></i>
            </div>
            <div class="podcast-info">
                <div class="podcast-title">Session {{ session.session_number }}: {{ session.title }}</div>
                <div class="podcast-subtitle">
                    {% if session.reading_audio %}
                    <i class="fas fa-microphone"></i> Instructor Audio
                    {% else %}
                    <i class="fas fa-robot"></i> Text-to-Speech
                    {% endif %}
                </div>
            </div>
            <div class="podcast-badge">
                <i class="fas fa-podcast"></i> PODCAST MODE
            </div>
        </div>

        {% if session.reading_audio %}
        <!-- Uploaded MP3 Audio Player -->
        <div class="audio-player-wrapper">
            <audio id="audioPlayer" preload="metadata">
                <source src="{{ url_for('static', filename=session.reading_audio) }}" type="audio/mpeg">
                Your browser does not support the audio element.
            </audio>
            <div class="custom-audio-controls">
                <button class="audio-btn play-btn" id="playPauseBtn" onclick="toggleAudioPlay()">
                    <i class="fas fa-play" id="playIcon"></i>
                </button>
                <div class="audio-progress-section">
                    <span class="audio-time" id="currentTime">0:00</span>
                    <div class="audio-progress-bar" id="audioProgressBar" onclick="seekAudio(event)">
                        <div class="audio-progress-fill" id="audioProgressFill"></div>
                        <div class="audio-progress-handle" id="audioHandle"></div>
                    </div>
                    <span class="audio-time" id="totalTime">0:00</span>
                </div>
                <div class="audio-extra-controls">
                    <button class="audio-btn small" onclick="skipAudio(-10)" title="Rewind 10s">
                        <i class="fas fa-undo"></i> 10
                    </button>
                    <button class="audio-btn small" onclick="skipAudio(10)" title="Forward 10s">
                        10 <i class="fas fa-redo"></i>
                    </button>
                    <select class="speed-select" id="speedSelect" onchange="changeAudioSpeed(this.value)">
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                    </select>
                    <button class="audio-btn small" id="volumeBtn" onclick="toggleMute()">
                        <i class="fas fa-volume-up" id="volumeIcon"></i>
                    </button>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Web Speech API Text-to-Speech Player -->
        <div class="audio-player-wrapper">
            <div class="custom-audio-controls">
                <button class="audio-btn play-btn" id="ttsPlayBtn" onclick="toggleTTS()">
                    <i class="fas fa-play" id="ttsPlayIcon"></i>
                </button>
                <div class="audio-progress-section">
                    <span class="audio-time" id="ttsStatus">Ready</span>
                    <div class="audio-progress-bar">
                        <div class="audio-progress-fill" id="ttsProgressFill" style="width: 0%;"></div>
                    </div>
                    <span class="audio-time" id="ttsPosition"></span>
                </div>
                <div class="audio-extra-controls">
                    <button class="audio-btn small" onclick="stopTTS()" title="Stop">
                        <i class="fas fa-stop"></i>
                    </button>
                    <select class="speed-select" id="ttsSpeedSelect" onchange="updateTTSRate()">
                        <option value="0.7">0.7x</option>
                        <option value="0.85">0.85x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.2">1.2x</option>
                        <option value="1.5">1.5x</option>
                    </select>
                    <select class="speed-select" id="ttsVoiceSelect" onchange="updateTTSVoice()" style="width: auto; max-width: 140px;">
                        <option value="">Default Voice</option>
                    </select>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="podcast-wave">
            <span></span><span></span><span></span><span></span><span></span>
            <span></span><span></span><span></span><span></span><span></span>
            <span></span><span></span><span></span><span></span><span></span>
        </div>
    </div>
    {% endif %}

    <!-- Reading Materials Content -->
    <div class="card" style="margin-bottom: 1.5rem;">
        <div class="card-header">
            <h3><i class="fas fa-book-reader"></i> Reading Materials â€” Session {{ session.session_number }}: {{ session.title }}</h3>
        </div>
        <div class="card-body">
            {% if session.reading_materials %}
            <div id="readingContent" class="reading-content" style="max-height: 600px; overflow-y: auto; padding: 1.5rem; line-height: 1.8; font-size: 1rem;">
                {{ session.reading_materials | safe }}
            </div>
            {% else %}
            <div class="empty-state" style="padding: 3rem;">
                <i class="fas fa-book-open" style="font-size: 3rem; color: #CBD5E1;"></i>
                <p>No reading materials have been added for this session yet.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Mark as Read Button (students only, if reading step not yet complete) -->
    {% if current_user.role == 'student' and progress %}
        {% if progress.get('step_reading') %}
        <div style="text-align: center; padding: 1rem;">
            <div style="background: #ECFDF5; border: 2px solid #10B981; border-radius: 12px; padding: 1rem 2rem; display: inline-block;">
                <i class="fas fa-check-circle" style="color: #10B981; font-size: 1.2rem;"></i>
                <span style="color: #065F46; font-weight: 600; margin-left: 8px;">Reading materials completed!</span>
            </div>
            <div style="margin-top: 1rem;">
                <a href="{{ url_for('student_session_activities', session_id=session.id) }}" class="btn btn-primary">
                    <i class="fas fa-arrow-right"></i> Go to Activities
                </a>
            </div>
        </div>
        {% elif session.reading_materials %}
        <div id="readingCompleteSection" style="text-align: center; padding: 1rem;">
            <p id="scrollHint" style="color: #94A3B8; font-size: 0.9rem;">
                <i class="fas fa-arrow-down"></i> Scroll to the bottom of the reading materials to enable the button
            </p>
            <button id="markReadBtn" class="btn btn-success" onclick="markReadingComplete({{ session.id }})" disabled
                    style="padding: 10px 28px; font-size: 1rem; opacity: 0.5; cursor: not-allowed;">
                <i class="fas fa-check"></i> I have finished reading
            </button>
        </div>
        {% endif %}
    {% endif %}
</div>

<style>
/* ==================== Podcast Player Styles ==================== */
.podcast-player {
    background: linear-gradient(135deg, #1E293B 0%, #334155 100%);
    border-radius: 16px;
    padding: 0;
    margin-bottom: 1.5rem;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}
.podcast-header {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 18px 22px 10px;
}
.podcast-icon {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #8B5CF6, #EC4899);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    color: white;
    flex-shrink: 0;
}
.podcast-info { flex: 1; }
.podcast-title {
    color: white;
    font-weight: 700;
    font-size: 1rem;
    line-height: 1.3;
}
.podcast-subtitle {
    color: #94A3B8;
    font-size: 0.8rem;
    margin-top: 2px;
}
.podcast-badge {
    background: rgba(139, 92, 246, 0.2);
    border: 1px solid rgba(139, 92, 246, 0.4);
    color: #A78BFA;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 1px;
    white-space: nowrap;
}

/* Audio Controls */
.audio-player-wrapper {
    padding: 12px 22px 18px;
}
.custom-audio-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}
.audio-btn {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}
.audio-btn:hover { color: #A78BFA; transform: scale(1.1); }
.audio-btn.play-btn {
    width: 44px;
    height: 44px;
    background: linear-gradient(135deg, #8B5CF6, #7C3AED);
    border-radius: 50%;
    font-size: 1rem;
    flex-shrink: 0;
    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
}
.audio-btn.play-btn:hover {
    transform: scale(1.08);
    box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5);
    color: white;
}
.audio-btn.small {
    font-size: 0.75rem;
    gap: 3px;
    padding: 4px 8px;
    border-radius: 6px;
    background: rgba(255,255,255,0.08);
}
.audio-progress-section {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 200px;
}
.audio-time {
    color: #94A3B8;
    font-size: 0.75rem;
    font-family: monospace;
    min-width: 36px;
    white-space: nowrap;
}
.audio-progress-bar {
    flex: 1;
    height: 6px;
    background: rgba(255,255,255,0.15);
    border-radius: 3px;
    cursor: pointer;
    position: relative;
    overflow: visible;
}
.audio-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #8B5CF6, #EC4899);
    border-radius: 3px;
    transition: width 0.1s linear;
    width: 0%;
}
.audio-progress-handle {
    width: 14px;
    height: 14px;
    background: white;
    border-radius: 50%;
    position: absolute;
    top: -4px;
    left: 0%;
    transform: translateX(-50%);
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    opacity: 0;
    transition: opacity 0.2s;
}
.audio-progress-bar:hover .audio-progress-handle { opacity: 1; }
.audio-extra-controls {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
}
.speed-select {
    background: rgba(255,255,255,0.08);
    color: #CBD5E1;
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 6px;
    padding: 4px 6px;
    font-size: 0.75rem;
    cursor: pointer;
    width: 60px;
}
.speed-select option { background: #1E293B; color: white; }

/* Waveform Animation */
.podcast-wave {
    display: flex;
    align-items: flex-end;
    justify-content: center;
    gap: 3px;
    height: 30px;
    padding: 0 22px 14px;
    opacity: 0.3;
}
.podcast-wave span {
    width: 3px;
    background: linear-gradient(to top, #8B5CF6, #EC4899);
    border-radius: 2px;
    height: 8px;
    transition: height 0.2s;
}
.podcast-player.playing .podcast-wave { opacity: 1; }
.podcast-player.playing .podcast-wave span {
    animation: waveform 1.2s ease-in-out infinite;
}
.podcast-wave span:nth-child(1)  { animation-delay: 0s; }
.podcast-wave span:nth-child(2)  { animation-delay: 0.1s; }
.podcast-wave span:nth-child(3)  { animation-delay: 0.2s; }
.podcast-wave span:nth-child(4)  { animation-delay: 0.3s; }
.podcast-wave span:nth-child(5)  { animation-delay: 0.15s; }
.podcast-wave span:nth-child(6)  { animation-delay: 0.25s; }
.podcast-wave span:nth-child(7)  { animation-delay: 0.05s; }
.podcast-wave span:nth-child(8)  { animation-delay: 0.35s; }
.podcast-wave span:nth-child(9)  { animation-delay: 0.18s; }
.podcast-wave span:nth-child(10) { animation-delay: 0.28s; }
.podcast-wave span:nth-child(11) { animation-delay: 0.08s; }
.podcast-wave span:nth-child(12) { animation-delay: 0.22s; }
.podcast-wave span:nth-child(13) { animation-delay: 0.12s; }
.podcast-wave span:nth-child(14) { animation-delay: 0.32s; }
.podcast-wave span:nth-child(15) { animation-delay: 0.02s; }
@keyframes waveform {
    0%, 100% { height: 6px; }
    50% { height: 24px; }
}

@media (max-width: 600px) {
    .podcast-header { flex-wrap: wrap; }
    .podcast-badge { display: none; }
    .custom-audio-controls { gap: 8px; }
    .audio-extra-controls { width: 100%; justify-content: center; margin-top: 6px; }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
{% if session.reading_audio %}
// ==================== Uploaded Audio Player ====================
const audio = document.getElementById('audioPlayer');
const playPauseBtn = document.getElementById('playPauseBtn');
const playIcon = document.getElementById('playIcon');
const progressFill = document.getElementById('audioProgressFill');
const handle = document.getElementById('audioHandle');
const currentTimeEl = document.getElementById('currentTime');
const totalTimeEl = document.getElementById('totalTime');
const podcastPlayer = document.getElementById('podcastPlayer');

audio.addEventListener('loadedmetadata', () => {
    totalTimeEl.textContent = formatTime(audio.duration);
});

audio.addEventListener('timeupdate', () => {
    if (audio.duration) {
        const pct = (audio.currentTime / audio.duration) * 100;
        progressFill.style.width = pct + '%';
        handle.style.left = pct + '%';
        currentTimeEl.textContent = formatTime(audio.currentTime);
    }
});

audio.addEventListener('ended', () => {
    playIcon.className = 'fas fa-play';
    podcastPlayer.classList.remove('playing');
});

function toggleAudioPlay() {
    if (audio.paused) {
        audio.play();
        playIcon.className = 'fas fa-pause';
        podcastPlayer.classList.add('playing');
    } else {
        audio.pause();
        playIcon.className = 'fas fa-play';
        podcastPlayer.classList.remove('playing');
    }
}

function seekAudio(e) {
    const bar = document.getElementById('audioProgressBar');
    const rect = bar.getBoundingClientRect();
    const pct = (e.clientX - rect.left) / rect.width;
    audio.currentTime = pct * audio.duration;
}

function skipAudio(sec) {
    audio.currentTime = Math.max(0, Math.min(audio.duration, audio.currentTime + sec));
}

function changeAudioSpeed(rate) {
    audio.playbackRate = parseFloat(rate);
}

function toggleMute() {
    audio.muted = !audio.muted;
    document.getElementById('volumeIcon').className = audio.muted ? 'fas fa-volume-mute' : 'fas fa-volume-up';
}

function formatTime(sec) {
    if (!sec || isNaN(sec)) return '0:00';
    var m = Math.floor(sec / 60), s = Math.floor(sec % 60);
    return m + ':' + (s < 10 ? '0' : '') + s;
}

{% else %}
// ==================== Web Speech API TTS ====================
let ttsUtterance = null;
let ttsPlaying = false;
let ttsPaused = false;
let ttsChunks = [];
let ttsCurrentChunk = 0;
let ttsSelectedVoice = null;

// Populate voices
function loadVoices() {
    const voices = speechSynthesis.getVoices();
    const select = document.getElementById('ttsVoiceSelect');
    if (!select || voices.length === 0) return;
    // Keep the default option
    select.innerHTML = '<option value="">Default Voice</option>';
    // Prefer English voices
    const enVoices = voices.filter(v => v.lang.startsWith('en'));
    const otherVoices = voices.filter(v => !v.lang.startsWith('en'));
    enVoices.forEach((v, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = v.name.substring(0, 30) + ' (' + v.lang + ')';
        opt.dataset.voiceName = v.name;
        select.appendChild(opt);
    });
}
if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = loadVoices;
}
loadVoices();

function getReadingText() {
    const el = document.getElementById('readingContent');
    if (!el) return '';
    // Get text content, strip HTML
    return el.innerText || el.textContent || '';
}

// Split text into chunks (Speech API has limits per utterance)
function splitTextToChunks(text, maxLen) {
    maxLen = maxLen || 200;
    const sentences = text.replace(/\n+/g, '. ').split(/(?<=[.!?])\s+/);
    const chunks = [];
    let current = '';
    for (const s of sentences) {
        if ((current + ' ' + s).length > maxLen && current.length > 0) {
            chunks.push(current.trim());
            current = s;
        } else {
            current = current ? current + ' ' + s : s;
        }
    }
    if (current.trim()) chunks.push(current.trim());
    return chunks;
}

function toggleTTS() {
    const playIcon = document.getElementById('ttsPlayIcon');
    const statusEl = document.getElementById('ttsStatus');
    const player = document.getElementById('podcastPlayer');

    if (ttsPlaying && !ttsPaused) {
        // Pause
        speechSynthesis.pause();
        ttsPaused = true;
        playIcon.className = 'fas fa-play';
        player.classList.remove('playing');
        statusEl.textContent = 'Paused';
        return;
    }
    if (ttsPaused) {
        // Resume
        speechSynthesis.resume();
        ttsPaused = false;
        playIcon.className = 'fas fa-pause';
        player.classList.add('playing');
        statusEl.textContent = 'Playing...';
        return;
    }

    // Start fresh
    const text = getReadingText();
    if (!text) { statusEl.textContent = 'No content'; return; }

    ttsChunks = splitTextToChunks(text, 200);
    ttsCurrentChunk = 0;
    ttsPlaying = true;
    ttsPaused = false;
    playIcon.className = 'fas fa-pause';
    player.classList.add('playing');
    statusEl.textContent = 'Playing...';
    speakNextChunk();
}

function speakNextChunk() {
    if (ttsCurrentChunk >= ttsChunks.length) {
        stopTTS();
        return;
    }

    const utterance = new SpeechSynthesisUtterance(ttsChunks[ttsCurrentChunk]);
    utterance.rate = parseFloat(document.getElementById('ttsSpeedSelect').value) || 1;

    // Set voice
    const voiceSelect = document.getElementById('ttsVoiceSelect');
    if (voiceSelect.value !== '') {
        const voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('en'));
        const idx = parseInt(voiceSelect.value);
        if (voices[idx]) utterance.voice = voices[idx];
    }

    utterance.onend = function() {
        ttsCurrentChunk++;
        // Update progress
        const pct = (ttsCurrentChunk / ttsChunks.length) * 100;
        document.getElementById('ttsProgressFill').style.width = pct + '%';
        document.getElementById('ttsPosition').textContent = ttsCurrentChunk + '/' + ttsChunks.length;
        if (ttsPlaying && !ttsPaused) speakNextChunk();
    };
    utterance.onerror = function() {
        ttsCurrentChunk++;
        if (ttsPlaying) speakNextChunk();
    };

    ttsUtterance = utterance;
    speechSynthesis.speak(utterance);
}

function stopTTS() {
    speechSynthesis.cancel();
    ttsPlaying = false;
    ttsPaused = false;
    ttsCurrentChunk = 0;
    document.getElementById('ttsPlayIcon').className = 'fas fa-play';
    document.getElementById('ttsStatus').textContent = 'Ready';
    document.getElementById('ttsProgressFill').style.width = '0%';
    document.getElementById('ttsPosition').textContent = '';
    document.getElementById('podcastPlayer').classList.remove('playing');
}

function updateTTSRate() {
    // Rate will apply to next chunk
}

function updateTTSVoice() {
    // Voice will apply to next chunk; if playing, restart current chunk
    if (ttsPlaying && !ttsPaused) {
        speechSynthesis.cancel();
        speakNextChunk();
    }
}
{% endif %}

// ==================== Reading Completion ====================
{% if current_user.role == 'student' and not progress.get('step_reading') and session.reading_materials %}
const readingEl = document.getElementById('readingContent');
const markBtn = document.getElementById('markReadBtn');
const scrollHint = document.getElementById('scrollHint');

if (readingEl && markBtn) {
    readingEl.addEventListener('scroll', function() {
        const atBottom = readingEl.scrollTop + readingEl.clientHeight >= readingEl.scrollHeight - 30;
        if (atBottom) {
            markBtn.disabled = false;
            markBtn.style.opacity = '1';
            markBtn.style.cursor = 'pointer';
            if (scrollHint) scrollHint.style.display = 'none';
        }
    });
    if (readingEl.scrollHeight <= readingEl.clientHeight + 30) {
        markBtn.disabled = false;
        markBtn.style.opacity = '1';
        markBtn.style.cursor = 'pointer';
        if (scrollHint) scrollHint.style.display = 'none';
    }
}

async function markReadingComplete(sessionId) {
    markBtn.disabled = true;
    markBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    try {
        const response = await fetch('/api/session/complete-reading', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sessionId })
        });
        if (response.redirected || response.url.includes('/login')) {
            alert('Session expired. Please log in again.');
            window.location.href = '/login';
            return;
        }
        const data = await response.json();
        if (data.success) {
            window.location.href = '/student/session/' + sessionId + '/activities';
        } else {
            alert(data.error || 'Error completing reading');
            markBtn.disabled = false;
            markBtn.innerHTML = '<i class="fas fa-check"></i> I have finished reading';
        }
    } catch (err) {
        alert('Error: ' + err.message);
        markBtn.disabled = false;
        markBtn.innerHTML = '<i class="fas fa-check"></i> I have finished reading';
    }
}
{% endif %}
</script>
{% endblock %}
