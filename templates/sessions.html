{% extends 'base.html' %}

{% block title %}{{ subject.name }} - {{ subject.section }}{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <span class="schedule-badge"><i class="fas fa-clock"></i> {{ subject.day }} {{ subject.time_schedule }}</span>
        <h1><i class="fas fa-book"></i> {{ subject.name }}</h1>
        <p class="section-info">{{ subject.section }}</p>
    </div>
    <div class="flex gap-10">
        {% if current_user.role == 'instructor' %}
        <button class="btn btn-teal" onclick="bulkToggleVisibility('show')" id="btnShowAll" title="Show all sessions, activities, quizzes & exams to students">
            <i class="fas fa-eye"></i> Show All
        </button>
        <button class="btn btn-danger" onclick="bulkToggleVisibility('hide')" id="btnHideAll" title="Hide all sessions, activities, quizzes & exams from students">
            <i class="fas fa-eye-slash"></i> Hide All
        </button>
        {% endif %}
        <a href="{{ url_for('all_activities', subject_id=subject.id) }}" class="btn btn-success">
            <i class="fas fa-tasks"></i> All Activities
        </a>
        <a href="{{ url_for('subject_exams', subject_id=subject.id) }}" class="btn btn-violet">
            <i class="fas fa-file-alt"></i> Exams
        </a>
        {% if current_user.role == 'instructor' %}
        <a href="{{ url_for('project_groups', subject_id=subject.id) }}" class="btn btn-warning">
            <i class="fas fa-users-cog"></i> Project Groups
        </a>
        {% endif %}
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back
        </a>
    </div>
</div>

{% if current_user.role == 'instructor' and total_enrolled is defined and total_enrolled > 0 %}
<div class="enrolled-bar">
    <div class="enrolled-header">
        <span><i class="fas fa-users"></i> Enrolled Students ({{ total_enrolled }})</span>
    </div>
    <div class="enrolled-avatars">
        {% for student in enrolled_students[:20] %}
        <div class="avatar-chip" title="{{ student.full_name }}">
            <img src="/static/uploads/photos/{{ student.photo or 'default.png' }}" alt="{{ student.full_name }}" onerror="this.src='/static/uploads/photos/default.png'">
            <span class="avatar-name">{{ student.full_name.split(' ')[0] }}</span>
        </div>
        {% endfor %}
        {% if total_enrolled > 20 %}
        <div class="avatar-more">+{{ total_enrolled - 20 }} more</div>
        {% endif %}
    </div>
</div>
{% endif %}

<div class="card">
    <div class="card-header">
        <h3><i class="fas fa-list"></i> Sessions ({{ sessions|length }})</h3>
        {% if current_user.role == 'instructor' %}
        <span class="badge badge-active">Visibility controls enabled</span>
        {% endif %}
    </div>
    <div class="card-body" style="padding: 0;">
        <ul class="session-list" style="padding: 1rem;">
            {% for session in sessions %}
            {% set stats = session_stats.get(session.id, {}) if session_stats is defined else {} %}
            <li class="session-item">
                <div class="session-info">
                    <div class="session-number">{{ session.session_number }}</div>
                    <div class="session-details">
                        <div class="session-title">{{ session.title }}</div>
                        <div class="session-meta">
                            {% if session.is_visible %}
                                <span class="badge badge-visible"><i class="fas fa-eye"></i> Visible</span>
                            {% else %}
                                <span class="badge badge-hidden"><i class="fas fa-eye-slash"></i> Hidden</span>
                            {% endif %}
                        </div>
                        {% if current_user.role == 'instructor' and stats %}
                        <div class="session-completion">
                            {% if stats.completed_students %}
                            <div class="completion-avatars">
                                {% for st in stats.completed_students[:8] %}
                                <img class="mini-avatar" src="/static/uploads/photos/{{ st.photo or 'default.png' }}" alt="{{ st.full_name }}" title="{{ st.full_name }}" onerror="this.src='/static/uploads/photos/default.png'">
                                {% endfor %}
                                {% if stats.completed_count > 8 %}
                                <span class="mini-avatar-more" title="{{ stats.completed_count }} students completed">+{{ stats.completed_count - 8 }}</span>
                                {% endif %}
                            </div>
                            <span class="completion-count">
                                <i class="fas fa-check-circle"></i> {{ stats.completed_count }}/{{ total_enrolled }} completed
                            </span>
                            {% else %}
                            <span class="completion-count none">
                                <i class="fas fa-clock"></i> No submissions yet
                            </span>
                            {% endif %}
                        </div>
                        {% if stats.activity_count > 0 or stats.quiz_count > 0 %}
                        <div class="session-performance-stats">
                            {% if stats.activity_count > 0 %}
                            <div class="perf-pill blue">
                                <i class="fas fa-tasks"></i>
                                <span class="perf-label">Activities</span>
                                <span class="perf-value">{{ stats.students_submitted }}/{{ total_enrolled }}</span>
                                {% if stats.graded_count > 0 %}
                                <span class="perf-score">avg {{ stats.avg_score }}%</span>
                                {% endif %}
                                <div class="perf-bar">
                                    <div class="perf-bar-fill blue" style="width: {{ (stats.students_submitted / total_enrolled * 100)|round|int if total_enrolled > 0 else 0 }}%"></div>
                                </div>
                            </div>
                            {% endif %}
                            {% if stats.quiz_count > 0 %}
                            <div class="perf-pill purple">
                                <i class="fas fa-question-circle"></i>
                                <span class="perf-label">Quiz</span>
                                <span class="perf-value">{{ stats.quiz_students_attempted }}/{{ total_enrolled }}</span>
                                {% if stats.quiz_avg_score > 0 %}
                                <span class="perf-score">avg {{ stats.quiz_avg_score }}%</span>
                                {% endif %}
                                <div class="perf-bar">
                                    <div class="perf-bar-fill purple" style="width: {{ (stats.quiz_students_attempted / total_enrolled * 100)|round|int if total_enrolled > 0 else 0 }}%"></div>
                                </div>
                            </div>
                            {% endif %}
                            {% if stats.peer_review_activities > 0 %}
                            <div class="perf-pill orange">
                                <i class="fas fa-user-friends"></i>
                                <span class="perf-label">Peer Review</span>
                                <span class="perf-value">{{ stats.peer_review_completed }}/{{ stats.peer_review_total }}</span>
                                <div class="perf-bar">
                                    <div class="perf-bar-fill orange" style="width: {{ (stats.peer_review_completed / stats.peer_review_total * 100)|round|int if stats.peer_review_total > 0 else 0 }}%"></div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endif %}
                        {% if current_user.role == 'instructor' %}
                        <div class="youtube-url-section">
                            <div class="youtube-input-group">
                                <i class="fab fa-youtube" style="color: #FF0000; font-size: 1.1rem;"></i>
                                <input type="text"
                                       class="youtube-url-input"
                                       id="youtube-url-{{ session.id }}"
                                       value="{{ session.youtube_url or '' }}"
                                       placeholder="Paste YouTube URL here..."
                                       onkeydown="if(event.key==='Enter'){event.preventDefault();saveYoutubeUrl({{ session.id }});}">
                                <input type="number"
                                       id="video-duration-{{ session.id }}"
                                       value="{{ session.video_duration or '' }}"
                                       placeholder="Duration (sec)"
                                       style="width: 110px; padding: 6px 8px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 0.85rem;"
                                       title="Video duration in seconds">
                                <button class="btn btn-sm btn-success" onclick="saveYoutubeUrl({{ session.id }})" title="Save YouTube URL">
                                    <i class="fas fa-save"></i>
                                </button>
                                {% if session.youtube_url %}
                                <button class="btn btn-sm btn-danger" onclick="clearYoutubeUrl({{ session.id }})" title="Remove video">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                            <div style="margin-top: 6px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                {% if session.youtube_url %}
                                <span class="badge badge-visible">
                                    <i class="fab fa-youtube"></i> Video linked
                                </span>
                                {% endif %}
                                <button class="btn btn-sm {% if session.reading_materials %}btn-primary{% else %}btn-secondary{% endif %}"
                                        onclick="openReadingEditor({{ session.id }}, '{{ session.title|e }}')" title="Edit reading materials">
                                    <i class="fas fa-book-reader"></i>
                                    {% if session.reading_materials %}Edit Reading{% else %}Add Reading{% endif %}
                                </button>
                                {% if session.reading_materials %}
                                <span class="badge badge-visible"><i class="fas fa-book"></i> Reading added</span>
                                {% endif %}
                                <!-- Audio Upload -->
                                <label class="btn btn-sm {% if session.reading_audio %}btn-teal{% else %}btn-secondary{% endif %}" title="Upload podcast audio for reading materials" style="cursor:pointer; margin:0;">
                                    <i class="fas fa-podcast"></i>
                                    {% if session.reading_audio %}Change Audio{% else %}Upload Audio{% endif %}
                                    <input type="file" accept=".mp3,.wav,.ogg,.m4a" style="display:none;"
                                           onchange="uploadReadingAudio({{ session.id }}, this)">
                                </label>
                                {% if session.reading_audio %}
                                <span class="badge badge-visible"><i class="fas fa-headphones"></i> Audio added</span>
                                <button class="btn btn-sm btn-danger" onclick="deleteReadingAudio({{ session.id }})" title="Remove audio">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="session-actions">
                    {% if current_user.role == 'instructor' %}
                    <div class="visibility-toggle">
                        <label class="toggle-switch">
                            <input type="checkbox"
                                   onchange="toggleVisibility('session', {{ session.id }})"
                                   {% if session.is_visible %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    {% endif %}
                    <a href="{{ url_for('session_lesson', session_id=session.id) }}" class="btn btn-sm btn-success">
                        <i class="fas fa-play-circle"></i> Lesson
                    </a>
                    <a href="{{ url_for('session_activities', session_id=session.id) }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-tasks"></i> Activities
                    </a>
                    <a href="{{ url_for('session_quiz', session_id=session.id) }}" class="btn btn-sm btn-violet">
                        <i class="fas fa-question-circle"></i> Quiz
                    </a>
                    {% if current_user.role == 'instructor' and session.session_number > 1 %}
                    <div class="unlock-dropdown" style="position: relative; display: inline-block;">
                        <button class="btn btn-sm btn-warning" onclick="toggleUnlockMenu({{ session.id }})" title="Manually unlock this session for students">
                            <i class="fas fa-unlock-alt"></i> Unlock
                        </button>
                        <div id="unlock-menu-{{ session.id }}" class="unlock-menu" style="display:none;">
                            <div class="unlock-menu-header">Unlock Session {{ session.session_number }} for:</div>
                            <button class="unlock-option" onclick="unlockSession({{ session.id }}, 'all')">
                                <i class="fas fa-users"></i> All Students
                            </button>
                            {% for student in enrolled_students %}
                            <button class="unlock-option" onclick="unlockSession({{ session.id }}, {{ student.id }})">
                                <img src="/static/uploads/photos/{{ student.photo or 'default.png' }}" class="unlock-avatar" onerror="this.src='/static/uploads/photos/default.png'">
                                {{ student.full_name }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>

<!-- Hidden reading materials data for TinyMCE editor -->
{% for session in sessions %}
<textarea id="reading-data-{{ session.id }}" style="display:none;">{{ session.reading_materials or '' }}</textarea>
{% endfor %}

<style>
/* Reading Materials Modal */
.reading-modal {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 9999;
    align-items: center;
    justify-content: center;
}
.reading-modal-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
}
.reading-modal-content {
    position: relative;
    background: white;
    border-radius: 16px;
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    z-index: 1;
}
.reading-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #E2E8F0;
}
.reading-modal-header h3 { margin: 0; font-size: 1.1rem; }
.reading-modal-body { padding: 1rem 1.5rem; flex: 1; overflow-y: auto; }
.reading-modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 1rem 1.5rem;
    border-top: 1px solid #E2E8F0;
}

/* YouTube URL Section */
.youtube-url-section {
    margin-top: 8px;
}
.youtube-input-group {
    display: flex;
    align-items: center;
    gap: 8px;
    max-width: 650px;
    flex-wrap: wrap;
}
.youtube-url-input {
    flex: 1;
    padding: 6px 10px;
    border: 1px solid #D1D5DB;
    border-radius: 6px;
    font-size: 0.85rem;
}
.youtube-url-input:focus {
    outline: none;
    border-color: #FF0000;
    box-shadow: 0 0 0 2px rgba(255, 0, 0, 0.1);
}

/* Enrolled Students Bar */
.enrolled-bar {
    background: white;
    border-radius: 12px;
    padding: 1rem 1.25rem;
    margin-bottom: 1.25rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border-left: 4px solid #8B5CF6;
}

.enrolled-header {
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.75rem;
    font-size: 0.95rem;
}

.enrolled-header i {
    color: #8B5CF6;
    margin-right: 6px;
}

.enrolled-avatars {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
}

.avatar-chip {
    display: flex;
    align-items: center;
    gap: 6px;
    background: #F3F4F6;
    border-radius: 20px;
    padding: 4px 10px 4px 4px;
    transition: background 0.2s;
}

.avatar-chip:hover {
    background: #EDE9FE;
}

.avatar-chip img {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.avatar-name {
    font-size: 0.8rem;
    color: #4B5563;
    font-weight: 500;
    max-width: 80px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.avatar-more {
    background: #8B5CF6;
    color: white;
    border-radius: 20px;
    padding: 6px 12px;
    font-size: 0.8rem;
    font-weight: 600;
}

/* Session Completion Row */
.session-details {
    flex: 1;
}

.session-completion {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 6px;
}

.completion-avatars {
    display: flex;
    align-items: center;
}

.mini-avatar {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid white;
    margin-left: -8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    transition: transform 0.2s;
}

.mini-avatar:first-child {
    margin-left: 0;
}

.mini-avatar:hover {
    transform: scale(1.2);
    z-index: 2;
    position: relative;
}

.mini-avatar-more {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background: #8B5CF6;
    color: white;
    font-size: 0.65rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: -8px;
    border: 2px solid white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
}

.completion-count {
    font-size: 0.8rem;
    color: #059669;
    font-weight: 600;
    white-space: nowrap;
}

.completion-count i {
    margin-right: 3px;
}

.completion-count.none {
    color: #9CA3AF;
}

/* Performance Stats Pills */
.session-performance-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
}

.perf-pill {
    display: flex;
    align-items: center;
    gap: 6px;
    background: #F8FAFC;
    border: 1px solid #E2E8F0;
    border-radius: 8px;
    padding: 6px 10px;
    font-size: 0.75rem;
    min-width: 150px;
    flex-wrap: wrap;
}

.perf-pill i {
    font-size: 0.7rem;
    width: 16px;
    text-align: center;
}

.perf-pill.blue  { border-left: 3px solid #0EA5E9; }
.perf-pill.blue i { color: #0EA5E9; }
.perf-pill.purple  { border-left: 3px solid #8B5CF6; }
.perf-pill.purple i { color: #8B5CF6; }
.perf-pill.orange  { border-left: 3px solid #F59E0B; }
.perf-pill.orange i { color: #F59E0B; }

.perf-label {
    color: #64748B;
    font-weight: 500;
}

.perf-value {
    font-weight: 700;
    color: #1E293B;
}

.perf-score {
    color: #10B981;
    font-weight: 600;
    margin-left: 2px;
}

.perf-bar {
    width: 100%;
    height: 3px;
    background: #E2E8F0;
    border-radius: 2px;
    margin-top: 4px;
    overflow: hidden;
}

.perf-bar-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.6s ease;
}

.perf-bar-fill.blue   { background: #0EA5E9; }
.perf-bar-fill.purple { background: #8B5CF6; }
.perf-bar-fill.orange { background: #F59E0B; }

/* Unlock Dropdown */
.unlock-menu {
    position: absolute;
    right: 0;
    top: 100%;
    background: white;
    border: 1px solid #E2E8F0;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    min-width: 220px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 100;
    padding: 6px;
}
.unlock-menu-header {
    padding: 8px 12px;
    font-size: 0.8rem;
    font-weight: 600;
    color: #64748B;
    border-bottom: 1px solid #E2E8F0;
    margin-bottom: 4px;
}
.unlock-option {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
    padding: 8px 12px;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 0.85rem;
    border-radius: 6px;
    text-align: left;
    color: #1E293B;
}
.unlock-option:hover {
    background: #F1F5F9;
}
.unlock-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    object-fit: cover;
}

@media (max-width: 768px) {
    .session-performance-stats {
        flex-direction: column;
    }
    .perf-pill {
        min-width: unset;
        width: 100%;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
async function saveYoutubeUrl(sessionId) {
    const input = document.getElementById('youtube-url-' + sessionId);
    const url = input.value.trim();
    const durationInput = document.getElementById('video-duration-' + sessionId);
    const duration = parseInt(durationInput ? durationInput.value : 0) || 0;

    try {
        const response = await fetch('/api/session/youtube-url', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sessionId, youtube_url: url, video_duration: duration })
        });
        if (response.redirected || response.url.includes('/login')) {
            alert('Session expired. Please log in again.');
            location.href = '/login';
            return;
        }
        const data = await response.json();
        if (data.success) {
            location.reload();
        } else {
            alert('Failed: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred saving the YouTube URL. Please refresh the page and try again.');
    }
}

async function clearYoutubeUrl(sessionId) {
    if (!confirm('Remove the YouTube video link from this session?')) return;
    document.getElementById('youtube-url-' + sessionId).value = '';
    var durEl = document.getElementById('video-duration-' + sessionId);
    if (durEl) durEl.value = '';
    saveYoutubeUrl(sessionId);
}

// ==================== Reading Materials Editor ====================
var currentEditSessionId = null;

function openReadingEditor(sessionId, sessionTitle) {
    currentEditSessionId = sessionId;
    // Create modal if not exists
    var modal = document.getElementById('readingModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'readingModal';
        modal.innerHTML = `
            <div class="reading-modal-overlay" onclick="closeReadingEditor()"></div>
            <div class="reading-modal-content">
                <div class="reading-modal-header">
                    <h3><i class="fas fa-book-reader"></i> Edit Reading Materials - <span id="readingModalTitle"></span></h3>
                    <button onclick="closeReadingEditor()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#64748B;">&times;</button>
                </div>
                <div class="reading-modal-body">
                    <textarea id="readingEditor"></textarea>
                </div>
                <div class="reading-modal-footer">
                    <button class="btn btn-secondary" onclick="closeReadingEditor()">Cancel</button>
                    <button class="btn btn-success" onclick="saveReadingMaterials()" id="saveReadingBtn">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </div>
        `;
        modal.className = 'reading-modal';
        document.body.appendChild(modal);

        // Initialize TinyMCE
        if (typeof tinymce === 'undefined') {
            var script = document.createElement('script');
            script.src = 'https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js';
            script.onload = function() { initTinyMCE(); loadReadingContent(sessionId); };
            document.head.appendChild(script);
        } else {
            initTinyMCE();
            loadReadingContent(sessionId);
        }
    } else {
        loadReadingContent(sessionId);
    }
    document.getElementById('readingModalTitle').textContent = sessionTitle;
    modal.style.display = 'flex';
}

function initTinyMCE() {
    tinymce.init({
        selector: '#readingEditor',
        height: 400,
        menubar: true,
        plugins: 'lists link image table code wordcount',
        toolbar: 'undo redo | blocks | bold italic underline | alignleft aligncenter alignright | bullist numlist | link image table | code',
        content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; font-size: 14px; }'
    });
}

async function loadReadingContent(sessionId) {
    try {
        var r = await fetch('/api/session/' + sessionId + '/progress');
        // We'll just load from the page â€” fetch the session reading
    } catch(e) {}
    // Load reading content by fetching the session reading page
    try {
        var r = await fetch('/session/' + sessionId + '/reading');
        // Set content from existing data (we pass it via a hidden element)
    } catch(e) {}
    // For now, load from hidden data attribute
    var existingContent = document.getElementById('reading-data-' + sessionId);
    if (existingContent && tinymce.get('readingEditor')) {
        tinymce.get('readingEditor').setContent(existingContent.value);
    } else if (tinymce.get('readingEditor')) {
        tinymce.get('readingEditor').setContent('');
    }
}

function closeReadingEditor() {
    var modal = document.getElementById('readingModal');
    if (modal) modal.style.display = 'none';
}

async function saveReadingMaterials() {
    var content = tinymce.get('readingEditor').getContent();
    var btn = document.getElementById('saveReadingBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    try {
        var r = await fetch('/api/session/reading-materials', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: currentEditSessionId, content: content })
        });
        if (r.redirected || r.url.includes('/login')) {
            alert('Session expired.'); location.href = '/login'; return;
        }
        var d = await r.json();
        if (d.success) {
            closeReadingEditor();
            location.reload();
        } else {
            alert(d.error || 'Error saving');
        }
    } catch(e) {
        alert('Error: ' + e.message);
    }
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-save"></i> Save';
}

async function bulkToggleVisibility(action) {
    const label = action === 'show' ? 'SHOW' : 'HIDE';
    if (!confirm(`Are you sure you want to ${label} all sessions, activities, quizzes, and exams for this subject?`)) return;

    const btn = action === 'show' ? document.getElementById('btnShowAll') : document.getElementById('btnHideAll');
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${action === 'show' ? 'Showing' : 'Hiding'}...`;

    try {
        const response = await fetch('/api/bulk-toggle-subject-visibility', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ subject_id: {{ subject.id }}, action: action })
        });
        const data = await response.json();
        if (data.success) {
            location.reload();
        } else {
            alert('Failed: ' + (data.error || 'Unknown error'));
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred');
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
}

// ==================== Session Unlock ====================
function toggleUnlockMenu(sessionId) {
    // Close all other menus first
    document.querySelectorAll('.unlock-menu').forEach(m => m.style.display = 'none');
    var menu = document.getElementById('unlock-menu-' + sessionId);
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

// Close unlock menus when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.unlock-dropdown')) {
        document.querySelectorAll('.unlock-menu').forEach(m => m.style.display = 'none');
    }
});

async function unlockSession(sessionId, studentId) {
    var label = studentId === 'all' ? 'ALL enrolled students' : 'this student';
    if (!confirm('Unlock this session for ' + label + '? This will mark the previous session as complete.')) return;
    try {
        var r = await fetch('/api/session/unlock', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sessionId, student_id: studentId })
        });
        if (r.redirected || r.url.includes('/login')) { alert('Session expired.'); location.href = '/login'; return; }
        var d = await r.json();
        if (d.success) {
            alert('Session unlocked for ' + d.unlocked + ' student(s)!');
            location.reload();
        } else {
            alert(d.error || 'Error unlocking');
        }
    } catch(e) {
        alert('Error: ' + e.message);
    }
}

// ==================== Audio Upload ====================
async function uploadReadingAudio(sessionId, input) {
    if (!input.files || !input.files[0]) return;
    var file = input.files[0];
    var allowed = ['.mp3', '.wav', '.ogg', '.m4a'];
    var ext = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
    if (!allowed.includes(ext)) {
        alert('Only MP3, WAV, OGG, and M4A files are allowed.');
        input.value = '';
        return;
    }
    if (file.size > 50 * 1024 * 1024) {
        alert('File too large. Maximum 50MB allowed.');
        input.value = '';
        return;
    }
    var formData = new FormData();
    formData.append('session_id', sessionId);
    formData.append('audio', file);
    // Show uploading state
    var label = input.parentElement;
    var origHTML = label.innerHTML;
    label.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
    try {
        var r = await fetch('/api/session/reading-audio', {
            method: 'POST',
            body: formData
        });
        if (r.redirected || r.url.includes('/login')) {
            alert('Session expired.'); location.href = '/login'; return;
        }
        var d = await r.json();
        if (d.success) {
            location.reload();
        } else {
            alert(d.error || 'Error uploading audio');
            label.innerHTML = origHTML;
        }
    } catch(e) {
        alert('Error: ' + e.message);
        label.innerHTML = origHTML;
    }
}

async function deleteReadingAudio(sessionId) {
    if (!confirm('Remove the podcast audio from this session?')) return;
    try {
        var r = await fetch('/api/session/reading-audio/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sessionId })
        });
        if (r.redirected || r.url.includes('/login')) {
            alert('Session expired.'); location.href = '/login'; return;
        }
        var d = await r.json();
        if (d.success) {
            location.reload();
        } else {
            alert(d.error || 'Error removing audio');
        }
    } catch(e) {
        alert('Error: ' + e.message);
    }
}

async function toggleVisibility(type, id) {
    try {
        const response = await fetch('/api/toggle-visibility', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: type, id: id })
        });
        const data = await response.json();
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to update visibility');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred');
    }
}
</script>
{% endblock %}
