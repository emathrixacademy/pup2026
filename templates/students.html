{% extends 'base.html' %}

{% block title %}Students - Sangrenes LMS Portal{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1><i class="fas fa-users"></i> Student Management</h1>
        <p>Manage student accounts and enrollments</p>
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-primary" onclick="openModal('bulkEnrollModal')">
            <i class="fas fa-book-open"></i> Enroll All
        </button>
        <button class="btn btn-success" onclick="openModal('addStudentModal')">
            <i class="fas fa-user-plus"></i> Add Student
        </button>
    </div>
</div>

<!-- Filters -->
<div class="filter-bar">
    <div class="filter-group">
        <label><i class="fas fa-filter"></i> Filter by:</label>
        <select id="filterSection" onchange="filterStudents()">
            <option value="">All Sections</option>
            {% for sec in sections %}
            <option value="{{ sec }}">{{ sec }}</option>
            {% endfor %}
        </select>
        <select id="filterSubject" onchange="filterStudents()">
            <option value="">All Subjects</option>
            {% for subject in subjects %}
            <option value="{{ subject.code }} {{ subject.section }}">{{ subject.code }} - {{ subject.section }}</option>
            {% endfor %}
        </select>
        <input type="text" id="searchName" placeholder="Search name or ID..." oninput="filterStudents()" class="filter-search">
    </div>
    <div class="filter-count">
        Showing <span id="visibleCount">{{ students|length }}</span> of {{ students|length }} students
    </div>
</div>

<div class="card">
    <div class="card-header">
        <span class="card-title">All Students ({{ students|length }})</span>
    </div>
    <div class="table-container">
        <table id="studentsTable">
            <thead>
                <tr>
                    <th style="width:60px">Photo</th>
                    <th>Student ID</th>
                    <th>Full Name</th>
                    <th>Username</th>
                    <th>Section</th>
                    <th>Enrolled In</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                {% set enroll = enrollment_map.get(student.id) %}
                <tr class="student-row"
                    data-section="{{ student.section or '' }}"
                    data-subjects="{{ enroll.enrolled_subjects if enroll else '' }}"
                    data-name="{{ student.full_name|lower }}"
                    data-sid="{{ student.student_id|lower if student.student_id else '' }}">
                    <td>
                        <div class="student-avatar">
                            {% if student.photo and student.photo != 'default.png' %}
                            <img src="{{ url_for('static', filename='uploads/photos/' + student.photo) }}" alt="{{ student.full_name }}">
                            {% else %}
                            <div class="avatar-initials">{{ student.full_name[:2]|upper }}</div>
                            {% endif %}
                        </div>
                    </td>
                    <td><span class="sid-badge">{{ student.student_id or 'N/A' }}</span></td>
                    <td>
                        <div class="student-name">{{ student.full_name }}</div>
                        {% if student.email %}
                        <small class="text-muted">{{ student.email }}</small>
                        {% endif %}
                    </td>
                    <td><code class="username-code">{{ student.username }}</code></td>
                    <td><span class="section-badge">{{ student.section or 'N/A' }}</span></td>
                    <td>
                        {% if enroll %}
                        <span class="enroll-count" title="{{ enroll.enrolled_subjects }}">{{ enroll.subject_count }} subject{{ 's' if enroll.subject_count != 1 }}</span>
                        {% else %}
                        <span class="enroll-none">Not enrolled</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-btns">
                            <a href="{{ url_for('manage_enrollments', student_id=student.id) }}" class="btn btn-sm btn-primary" title="Manage Subjects">
                                <i class="fas fa-book"></i> Enroll
                            </a>
                            <a href="{{ url_for('student_grades', student_id=student.id) }}" class="btn btn-sm btn-teal" title="View Grades">
                                <i class="fas fa-chart-bar"></i> Grades
                            </a>
                            <a href="{{ url_for('delete_student', id=student.id) }}" class="btn btn-sm btn-danger" onclick="return confirmDelete('Delete this student?')" title="Delete Student">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="text-center">No students yet. Add students individually or upload a file.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Bulk Upload Section -->
<div class="upload-section">
    <h3>Bulk Upload Students</h3>
    <p>Upload an Excel (.xlsx) or CSV file with columns: student_id, username, password, full_name, section</p>
    <form action="{{ url_for('bulk_upload_students') }}" method="POST" enctype="multipart/form-data" class="mt-20">
        <input type="file" name="file" accept=".xlsx,.xls,.csv" required>
        <button type="submit" class="btn btn-amber mt-20">Upload File</button>
    </form>
</div>

<!-- Add Student Modal -->
<div id="addStudentModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3><i class="fas fa-user-plus"></i> Add New Student</h3>
            <span class="modal-close" onclick="closeModal('addStudentModal')">&times;</span>
        </div>
        <form action="{{ url_for('add_student') }}" method="POST">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label><i class="fas fa-id-card"></i> Student ID</label>
                    <input type="text" name="student_id" placeholder="e.g., 2021-00001" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Full Name</label>
                    <input type="text" name="full_name" placeholder="Juan Dela Cruz" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-at"></i> Username</label>
                    <input type="text" name="username" placeholder="jdelacruz" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Password</label>
                    <input type="password" name="password" placeholder="********" required>
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label><i class="fas fa-users"></i> Section</label>
                    <input type="text" name="section" placeholder="e.g., BSIT-SR 3-1">
                </div>
            </div>

            <div class="form-group" style="margin-top: 1rem;">
                <label><i class="fas fa-book"></i> Enroll in Subjects</label>
                <p style="font-size: 0.85rem; color: var(--text-gray); margin-bottom: 0.5rem;">
                    Select the subjects this student will be enrolled in:
                </p>
                <div class="subject-checkboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem;">
                    {% for subject in subjects %}
                    <label class="checkbox-label" style="display: flex; align-items: center; padding: 0.5rem; margin-bottom: 0.25rem; cursor: pointer; border-radius: 4px; transition: background 0.2s;">
                        <input type="checkbox" name="subjects" value="{{ subject.id }}" style="margin-right: 0.75rem; width: 18px; height: 18px;">
                        <span>
                            <strong>{{ subject.code }}</strong> - {{ subject.name }}
                            <small style="display: block; color: var(--text-gray);">{{ subject.section }} | {{ subject.day }} {{ subject.time_schedule }}</small>
                        </span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <button type="submit" class="btn btn-success btn-full" style="margin-top: 1rem;">
                <i class="fas fa-check"></i> Add Student & Enroll
            </button>
        </form>
    </div>
</div>

<!-- Bulk Enroll Modal -->
<div id="bulkEnrollModal" class="modal">
    <div class="modal-content" style="max-width: 550px;">
        <div class="modal-header">
            <h3><i class="fas fa-book-open"></i> Bulk Enroll Students</h3>
            <span class="modal-close" onclick="closeModal('bulkEnrollModal')">&times;</span>
        </div>
        <form action="{{ url_for('bulk_enroll_students') }}" method="POST" onsubmit="return prepareBulkEnroll()">
            <input type="hidden" name="mode" id="bulkEnrollMode" value="all">
            <input type="hidden" name="student_ids" id="bulkEnrollStudentIds" value="">

            <!-- Enroll scope -->
            <div class="bulk-enroll-scope">
                <label class="scope-option active" onclick="setBulkScope('all', this)">
                    <input type="radio" name="scope" value="all" checked style="display:none;">
                    <i class="fas fa-users"></i>
                    <div>
                        <strong>All Students</strong>
                        <small>Enroll all {{ students|length }} students</small>
                    </div>
                </label>
                <label class="scope-option" onclick="setBulkScope('filtered', this)">
                    <input type="radio" name="scope" value="filtered" style="display:none;">
                    <i class="fas fa-filter"></i>
                    <div>
                        <strong>Filtered Only</strong>
                        <small>Enroll only currently visible students</small>
                    </div>
                </label>
            </div>

            <div class="form-group" style="margin-top: 1rem;">
                <label><i class="fas fa-book"></i> Select Subjects to Enroll In</label>
                <p style="font-size: 0.82rem; color: #6B7280; margin-bottom: 0.5rem;">
                    Students already enrolled in a subject will be skipped (no duplicates).
                </p>
                <div class="bulk-subject-list">
                    {% for subject in subjects %}
                    <label class="bulk-subject-item">
                        <input type="checkbox" name="subjects" value="{{ subject.id }}">
                        <span class="bulk-subject-info">
                            <strong>{{ subject.code }}</strong> - {{ subject.name }}
                            <small>{{ subject.section }} | {{ subject.day }} {{ subject.time_schedule }}</small>
                        </span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <button type="submit" class="btn btn-primary btn-full" style="margin-top: 1rem;">
                <i class="fas fa-check-double"></i> Enroll Students
            </button>
        </form>
    </div>
</div>

<style>
/* Bulk Enroll Modal */
.bulk-enroll-scope {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 0.5rem;
}

.scope-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px;
    border: 2px solid #E5E7EB;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
}

.scope-option:hover { border-color: #C4B5FD; background: #FAFAFE; }
.scope-option.active { border-color: #8B5CF6; background: #EDE9FE; }

.scope-option i { font-size: 1.3rem; color: #8B5CF6; }
.scope-option strong { display: block; font-size: 0.9rem; color: #1F2937; }
.scope-option small { color: #6B7280; font-size: 0.78rem; }

.bulk-subject-list {
    max-height: 250px;
    overflow-y: auto;
    border: 1px solid #E5E7EB;
    border-radius: 8px;
    padding: 0.5rem;
}

.bulk-subject-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    cursor: pointer;
    border-radius: 6px;
    transition: background 0.15s;
}

.bulk-subject-item:hover { background: #F3F4F6; }

.bulk-subject-item input[type="checkbox"] { width: 18px; height: 18px; accent-color: #8B5CF6; flex-shrink: 0; }

.bulk-subject-info { flex: 1; }
.bulk-subject-info strong { color: #1F2937; font-size: 0.88rem; }
.bulk-subject-info small { display: block; color: #6B7280; font-size: 0.78rem; margin-top: 2px; }

/* Filter Bar */
.filter-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 14px 20px;
    border-radius: 12px;
    margin-bottom: 16px;
    border: 1px solid #E5E7EB;
    flex-wrap: wrap;
    gap: 10px;
}
.filter-group {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}
.filter-group label {
    font-weight: 600;
    color: #6B7280;
    font-size: 0.85rem;
    white-space: nowrap;
}
.filter-group select, .filter-search {
    padding: 8px 12px;
    border: 1px solid #D1D5DB;
    border-radius: 8px;
    font-size: 0.85rem;
    background: #F9FAFB;
    color: #374151;
    min-width: 160px;
}
.filter-group select:focus, .filter-search:focus {
    outline: none;
    border-color: #6366F1;
    box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
}
.filter-search {
    min-width: 200px;
}
.filter-count {
    font-size: 0.85rem;
    color: #6B7280;
    white-space: nowrap;
}

/* Student Avatar */
.student-avatar {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid #E5E7EB;
    flex-shrink: 0;
}
.student-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.avatar-initials {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #6366F1, #8B5CF6);
    color: white;
    font-weight: 700;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
}

/* Student Name */
.student-name {
    font-weight: 600;
    color: #1E293B;
}

/* Badges */
.sid-badge {
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    font-weight: 600;
    color: #4F46E5;
    background: #EEF2FF;
    padding: 3px 8px;
    border-radius: 5px;
}
.username-code {
    background: #F1F5F9;
    padding: 3px 8px;
    border-radius: 5px;
    font-size: 0.85rem;
    color: #475569;
}
.section-badge {
    display: inline-block;
    background: #F0FDF4;
    color: #15803D;
    padding: 3px 10px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 600;
    border: 1px solid #BBF7D0;
}
.enroll-count {
    font-size: 0.8rem;
    font-weight: 600;
    color: #0369A1;
    background: #E0F2FE;
    padding: 3px 10px;
    border-radius: 6px;
    cursor: default;
    border: 1px solid #BAE6FD;
}
.enroll-none {
    font-size: 0.8rem;
    color: #9CA3AF;
    font-style: italic;
}

/* Action buttons */
.action-btns {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

/* Table styling */
#studentsTable tbody tr {
    transition: background 0.15s;
}
#studentsTable tbody tr:hover {
    background: #F8FAFC;
}

/* Checkbox label hover */
.checkbox-label:hover {
    background: var(--bg-light);
}
.checkbox-label input:checked + span {
    color: var(--primary-blue);
}

@media (max-width: 768px) {
    .filter-bar {
        flex-direction: column;
        align-items: stretch;
    }
    .filter-group {
        flex-direction: column;
        align-items: stretch;
    }
    .filter-group select, .filter-search {
        min-width: 100%;
    }
    .action-btns {
        flex-direction: column;
    }
}
</style>

<script>
function filterStudents() {
    const section = document.getElementById('filterSection').value;
    const subject = document.getElementById('filterSubject').value;
    const search = document.getElementById('searchName').value.toLowerCase().trim();
    const rows = document.querySelectorAll('.student-row');
    let visible = 0;

    rows.forEach(row => {
        const rowSection = row.dataset.section;
        const rowSubjects = row.dataset.subjects;
        const rowName = row.dataset.name;
        const rowSid = row.dataset.sid;

        let show = true;

        if (section && rowSection !== section) show = false;
        if (subject && !rowSubjects.includes(subject)) show = false;
        if (search && !rowName.includes(search) && !rowSid.includes(search)) show = false;

        row.style.display = show ? '' : 'none';
        if (show) visible++;
    });

    document.getElementById('visibleCount').textContent = visible;
}

function setBulkScope(scope, el) {
    document.querySelectorAll('.scope-option').forEach(o => o.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('bulkEnrollMode').value = scope === 'all' ? 'all' : 'selected';
}

function prepareBulkEnroll() {
    const mode = document.getElementById('bulkEnrollMode').value;
    const checked = document.querySelectorAll('#bulkEnrollModal input[name="subjects"]:checked');

    if (checked.length === 0) {
        alert('Please select at least one subject.');
        return false;
    }

    if (mode === 'selected') {
        // Collect IDs of currently visible student rows
        const visibleIds = [];
        document.querySelectorAll('.student-row').forEach(row => {
            if (row.style.display !== 'none') {
                // Extract student ID from the enroll link href
                const enrollLink = row.querySelector('a[href*="/enrollments"]');
                if (enrollLink) {
                    const match = enrollLink.href.match(/\/students\/(\d+)\/enrollments/);
                    if (match) visibleIds.push(match[1]);
                }
            }
        });
        document.getElementById('bulkEnrollStudentIds').value = visibleIds.join(',');

        if (visibleIds.length === 0) {
            alert('No students are visible with the current filters.');
            return false;
        }

        return confirm('Enroll ' + visibleIds.length + ' filtered student(s) in ' + checked.length + ' subject(s)?');
    }

    return confirm('Enroll ALL {{ students|length }} students in ' + checked.length + ' subject(s)?');
}
</script>
{% endblock %}
