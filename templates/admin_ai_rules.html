{% extends 'base.html' %}

{% block title %}AI Admin Rules - eMathrix LMS{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1><i class="fas fa-brain"></i> AI Admin Rules</h1>
        <p style="color: #64748B;">Configure automated AI behavior and monitoring triggers</p>
    </div>
    <div class="flex gap-10">
        <button class="btn btn-primary" onclick="openModal('addRuleModal')"><i class="fas fa-plus"></i> Add Rule</button>
        <a href="{{ url_for('admin_ai_logs') }}" class="btn btn-secondary"><i class="fas fa-list-alt"></i> View Logs</a>
    </div>
</div>

<!-- Stats -->
{% set active_count = rules|selectattr('is_active')|list|length %}
{% set inactive_count = rules|length - active_count %}
{% set total_triggers = rules|sum(attribute='trigger_count') %}
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 1.5rem;">
    <div style="background: white; border-radius: 12px; padding: 1.25rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #8B5CF6;">
        <div style="font-size: 2rem; font-weight: 700; color: #8B5CF6;">{{ rules|length }}</div>
        <div style="font-size: 0.85rem; color: #64748B;"><i class="fas fa-cogs"></i> Total Rules</div>
    </div>
    <div style="background: white; border-radius: 12px; padding: 1.25rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #10B981;">
        <div style="font-size: 2rem; font-weight: 700; color: #10B981;">{{ active_count }}</div>
        <div style="font-size: 0.85rem; color: #64748B;"><i class="fas fa-check-circle"></i> Active Rules</div>
    </div>
    <div style="background: white; border-radius: 12px; padding: 1.25rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #F59E0B;">
        <div style="font-size: 2rem; font-weight: 700; color: #F59E0B;">{{ inactive_count }}</div>
        <div style="font-size: 0.85rem; color: #64748B;"><i class="fas fa-pause-circle"></i> Inactive Rules</div>
    </div>
    <div style="background: white; border-radius: 12px; padding: 1.25rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #3B82F6;">
        <div style="font-size: 2rem; font-weight: 700; color: #3B82F6;">{{ total_triggers }}</div>
        <div style="font-size: 0.85rem; color: #64748B;"><i class="fas fa-bolt"></i> Total Triggers</div>
    </div>
</div>

<!-- AI Status Banner -->
<div class="card" style="margin-bottom: 1.5rem; overflow: hidden; border: none;">
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.25rem 1.5rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
        <div style="display: flex; align-items: center; gap: 14px;">
            <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-robot" style="color: white; font-size: 1.4rem;"></i>
            </div>
            <div>
                <div style="color: white; font-weight: 700; font-size: 1rem;">AI Admin Agent is Running</div>
                <div style="color: rgba(255,255,255,0.75); font-size: 0.8rem;">Monitoring every 30 minutes &middot; {{ active_count }} active rules &middot; {{ total_triggers }} actions taken</div>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 6px;">
            <span style="width: 10px; height: 10px; background: #4ADE80; border-radius: 50%; display: inline-block; animation: pulse 2s infinite;"></span>
            <span style="color: rgba(255,255,255,0.9); font-size: 0.8rem; font-weight: 600;">Live</span>
        </div>
    </div>
</div>

<style>
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

.rule-card {
    background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; position: relative;
}
.rule-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
.rule-card.inactive { opacity: 0.65; }
.rule-card .rule-header {
    padding: 1.1rem 1.25rem 0.75rem; display: flex; justify-content: space-between; align-items: flex-start;
}
.rule-card .rule-body { padding: 0 1.25rem 1rem; }
.rule-card .rule-footer {
    padding: 0.65rem 1.25rem; border-top: 1px solid #F1F5F9;
    display: flex; justify-content: space-between; align-items: center; background: #FAFBFC;
}

.rule-icon {
    width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
    font-size: 1rem; flex-shrink: 0;
}
.rule-icon.grade { background: linear-gradient(135deg, #FEE2E2, #FECACA); color: #DC2626; }
.rule-icon.deadline { background: linear-gradient(135deg, #FEF3C7, #FDE68A); color: #D97706; }
.rule-icon.progress { background: linear-gradient(135deg, #DBEAFE, #BFDBFE); color: #2563EB; }
.rule-icon.attendance { background: linear-gradient(135deg, #D1FAE5, #A7F3D0); color: #059669; }
.rule-icon.report { background: linear-gradient(135deg, #EDE9FE, #DDD6FE); color: #7C3AED; }
.rule-icon.payroll { background: linear-gradient(135deg, #CFFAFE, #A5F3FC); color: #0891B2; }
.rule-icon.activity { background: linear-gradient(135deg, #FCE7F3, #FBCFE8); color: #DB2777; }

.toggle-switch { position: relative; display: inline-block; width: 48px; height: 26px; cursor: pointer; }
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0; border-radius: 26px;
    background: #CBD5E1; transition: 0.3s;
}
.toggle-slider:before {
    content: ''; position: absolute; height: 20px; width: 20px; left: 3px; bottom: 3px;
    background: white; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}
.toggle-switch input:checked + .toggle-slider { background: #10B981; }
.toggle-switch input:checked + .toggle-slider:before { transform: translateX(22px); }

.condition-box {
    background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 8px; padding: 10px 14px;
    font-size: 0.82rem; display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
}
.condition-box .kw { font-weight: 400; color: #94A3B8; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
.condition-box .field { font-weight: 600; color: #334155; background: #E2E8F0; padding: 1px 8px; border-radius: 4px; }
.condition-box .op { font-weight: 700; color: #8B5CF6; }
.condition-box .val { font-weight: 700; color: #DC2626; background: #FEE2E2; padding: 1px 8px; border-radius: 4px; }

.action-badge {
    display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 6px;
    font-size: 0.72rem; font-weight: 600;
}
.action-badge.notification { background: #DBEAFE; color: #1E40AF; }
.action-badge.report { background: #EDE9FE; color: #6D28D9; }
.action-badge.payroll { background: #CFFAFE; color: #0E7490; }
</style>

{% if not rules %}
<div class="card">
    <div class="card-body" style="text-align: center; padding: 3rem;">
        <i class="fas fa-brain" style="font-size: 3rem; color: #CBD5E1; margin-bottom: 1rem;"></i>
        <h3 style="color: #475569;">No AI Rules Configured</h3>
        <p style="color: #94A3B8;">Add rules to automate monitoring and actions. The AI agent will check these rules every 30 minutes.</p>
    </div>
</div>
{% else %}
<!-- Rules Grid -->
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 20px;">
    {% for rule in rules %}
    <div class="rule-card {{ 'inactive' if not rule.is_active }}">
        <div class="rule-header">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div class="rule-icon {{ 'grade' if 'grade' in rule.rule_type else ('deadline' if 'deadline' in rule.rule_type else ('progress' if 'progress' in rule.rule_type else ('attendance' if 'attendance' in rule.rule_type else ('report' if 'report' in rule.rule_type else ('payroll' if 'payroll' in rule.rule_type else 'activity'))))) }}">
                    {% if 'grade' in rule.rule_type %}<i class="fas fa-chart-line"></i>
                    {% elif 'deadline' in rule.rule_type %}<i class="fas fa-clock"></i>
                    {% elif 'progress' in rule.rule_type %}<i class="fas fa-tasks"></i>
                    {% elif 'attendance' in rule.rule_type %}<i class="fas fa-user-clock"></i>
                    {% elif 'report' in rule.rule_type %}<i class="fas fa-file-alt"></i>
                    {% elif 'payroll' in rule.rule_type %}<i class="fas fa-money-check-alt"></i>
                    {% else %}<i class="fas fa-eye"></i>
                    {% endif %}
                </div>
                <div>
                    <div style="font-weight: 700; color: #1E293B; font-size: 0.95rem; line-height: 1.2;">{{ rule.rule_name }}</div>
                    <div style="font-size: 0.72rem; color: #94A3B8; margin-top: 2px;">{{ rule.rule_type|replace('_', ' ')|title }}</div>
                </div>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" {% if rule.is_active %}checked{% endif %} onchange="toggleRule({{ rule.id }})">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <div class="rule-body">
            <!-- Condition -->
            <div class="condition-box" style="margin-bottom: 10px;">
                <span class="kw">When</span>
                <span class="field">{{ rule.condition_field }}</span>
                <span class="op">{{ rule.condition_operator|replace('_', ' ') }}</span>
                <span class="val">{{ rule.condition_value }}</span>
            </div>

            <!-- Action -->
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 0.75rem; color: #94A3B8;"><i class="fas fa-arrow-right"></i> Then:</span>
                {% if rule.action_type == 'send_notification' %}
                <span class="action-badge notification"><i class="fas fa-bell"></i> Send Notification</span>
                {% elif rule.action_type == 'generate_report' %}
                <span class="action-badge report"><i class="fas fa-file-alt"></i> Generate Report</span>
                {% elif rule.action_type == 'calculate_payroll' %}
                <span class="action-badge payroll"><i class="fas fa-calculator"></i> Calculate Payroll</span>
                {% else %}
                <span class="action-badge notification"><i class="fas fa-play"></i> {{ rule.action_type|replace('_', ' ')|title }}</span>
                {% endif %}
                {% if rule.priority > 0 %}
                <span style="background: #FEF3C7; color: #92400E; padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; margin-left: auto;">
                    <i class="fas fa-arrow-up"></i> P{{ rule.priority }}
                </span>
                {% endif %}
            </div>
        </div>

        <div class="rule-footer">
            <div style="display: flex; align-items: center; gap: 12px; font-size: 0.75rem; color: #94A3B8;">
                <span title="Times triggered"><i class="fas fa-bolt" style="color: #F59E0B;"></i> {{ rule.trigger_count }} trigger{{ 's' if rule.trigger_count != 1 }}</span>
                {% if rule.last_triggered_at %}
                <span title="Last triggered"><i class="fas fa-clock"></i> {{ rule.last_triggered_at[:10] }}</span>
                {% endif %}
            </div>
            <button onclick="deleteRule({{ rule.id }}, '{{ rule.rule_name }}')" style="background: none; border: none; color: #CBD5E1; cursor: pointer; padding: 4px; font-size: 0.85rem; transition: color 0.2s;" onmouseover="this.style.color='#EF4444'" onmouseout="this.style.color='#CBD5E1'" title="Delete rule">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Add Rule Modal -->
<div id="addRuleModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; backdrop-filter: blur(4px);">
    <div style="background:white; border-radius:16px; max-width:540px; width:92%; max-height:85vh; overflow-y:auto; margin:auto; position:relative; top:50%; transform:translateY(-50%); box-shadow: 0 25px 60px rgba(0,0,0,0.2);">
        <!-- Modal Header -->
        <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 20px 28px; border-radius: 16px 16px 0 0;">
            <h3 style="margin:0; color: white; font-size: 1.1rem;"><i class="fas fa-plus-circle"></i> Create AI Rule</h3>
            <p style="margin: 4px 0 0; color: rgba(255,255,255,0.7); font-size: 0.8rem;">Define a condition and action for the AI agent</p>
        </div>

        <div style="padding: 24px 28px;">
            <div style="display:flex; flex-direction:column; gap:16px;">
                <!-- Rule Name -->
                <div>
                    <label style="display:block; font-size:0.8rem; font-weight:600; color:#475569; margin-bottom:6px;">Rule Name <span style="color:#EF4444;">*</span></label>
                    <input type="text" id="ruleName" placeholder="e.g. Low Grade Alert" style="width:100%; padding:10px 14px; border:1px solid #E2E8F0; border-radius:10px; font-size:0.9rem; box-sizing:border-box; transition: border-color 0.2s;" onfocus="this.style.borderColor='#8B5CF6'" onblur="this.style.borderColor='#E2E8F0'">
                </div>

                <!-- Type & Action -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div>
                        <label style="display:block; font-size:0.8rem; font-weight:600; color:#475569; margin-bottom:6px;">Monitor Type</label>
                        <select id="ruleType" style="width:100%; padding:10px 14px; border:1px solid #E2E8F0; border-radius:10px; font-size:0.85rem; box-sizing:border-box; background:white;">
                            <option value="grade_monitor">Grade Monitor</option>
                            <option value="deadline_monitor">Deadline Monitor</option>
                            <option value="progress_monitor">Progress Monitor</option>
                            <option value="attendance_monitor">Attendance Monitor</option>
                            <option value="report_generator">Report Generator</option>
                            <option value="payroll_processor">Payroll Processor</option>
                            <option value="activity_monitor">Activity Monitor</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block; font-size:0.8rem; font-weight:600; color:#475569; margin-bottom:6px;">Action</label>
                        <select id="actionType" style="width:100%; padding:10px 14px; border:1px solid #E2E8F0; border-radius:10px; font-size:0.85rem; box-sizing:border-box; background:white;">
                            <option value="send_notification">Send Notification</option>
                            <option value="generate_report">Generate Report</option>
                            <option value="calculate_payroll">Calculate Payroll</option>
                        </select>
                    </div>
                </div>

                <!-- Condition -->
                <div>
                    <label style="display:block; font-size:0.8rem; font-weight:600; color:#475569; margin-bottom:6px;">Condition</label>
                    <div style="display:grid; grid-template-columns:2fr 1.5fr 1fr; gap:8px;">
                        <input type="text" id="condField" placeholder="Field (e.g. weighted_grade)" style="padding:10px 14px; border:1px solid #E2E8F0; border-radius:10px; font-size:0.85rem;">
                        <select id="condOp" style="padding:10px 14px; border:1px solid #E2E8F0; border-radius:10px; font-size:0.85rem; background:white;">
                            <option value="less_than">Less Than</option>
                            <option value="greater_than">Greater Than</option>
                            <option value="equals">Equals</option>
                        </select>
                        <input type="text" id="condValue" placeholder="Value" style="padding:10px 14px; border:1px solid #E2E8F0; border-radius:10px; font-size:0.85rem;">
                    </div>
                </div>

                <!-- Action Params -->
                <div>
                    <label style="display:block; font-size:0.8rem; font-weight:600; color:#475569; margin-bottom:6px;">Action Parameters <span style="color:#94A3B8; font-weight:400;">(JSON, optional)</span></label>
                    <textarea id="actionParams" placeholder='{"severity": "warning", "message_template": "Your grade in {subject} is {grade}%"}' rows="3" style="width:100%; padding:10px 14px; border:1px solid #E2E8F0; border-radius:10px; font-size:0.82rem; font-family: 'Courier New', monospace; resize: vertical; box-sizing:border-box;"></textarea>
                </div>

                <!-- Priority -->
                <div>
                    <label style="display:block; font-size:0.8rem; font-weight:600; color:#475569; margin-bottom:6px;">Priority <span style="color:#94A3B8; font-weight:400;">(higher = runs first)</span></label>
                    <input type="number" id="rulePriority" value="0" min="0" max="100" style="width:120px; padding:10px 14px; border:1px solid #E2E8F0; border-radius:10px; font-size:0.9rem;">
                </div>
            </div>

            <!-- Actions -->
            <div style="display:flex; gap:10px; margin-top:24px; justify-content:flex-end; padding-top: 16px; border-top: 1px solid #F1F5F9;">
                <button onclick="closeModal('addRuleModal')" style="padding:10px 24px; border:1px solid #E2E8F0; border-radius:10px; background:white; cursor:pointer; font-size:0.9rem; color: #64748B; font-weight: 500;">Cancel</button>
                <button onclick="createRule()" style="padding:10px 24px; border:none; border-radius:10px; background: linear-gradient(135deg, #667eea, #764ba2); color:white; cursor:pointer; font-weight:600; font-size:0.9rem; box-shadow: 0 4px 12px rgba(102,126,234,0.3);">
                    <i class="fas fa-plus"></i> Create Rule
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleRule(id) {
    fetch(`/api/admin/ai-rules/${id}/toggle`, { method: 'POST' })
        .then(r => r.json()).then(d => { if(d.success) location.reload(); });
}

function createRule() {
    const name = document.getElementById('ruleName').value.trim();
    if (!name) { alert('Please enter a rule name'); return; }

    const data = {
        rule_name: name,
        rule_type: document.getElementById('ruleType').value,
        condition_field: document.getElementById('condField').value,
        condition_operator: document.getElementById('condOp').value,
        condition_value: document.getElementById('condValue').value,
        action_type: document.getElementById('actionType').value,
        action_params: document.getElementById('actionParams').value || '{}',
        priority: parseInt(document.getElementById('rulePriority').value) || 0
    };
    fetch('/api/admin/ai-rules', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
    }).then(r => r.json()).then(d => { if(d.success) location.reload(); else alert('Failed to create rule'); });
}

function deleteRule(id, name) {
    if (!confirm(`Delete rule "${name}"? This cannot be undone.`)) return;
    fetch(`/api/admin/ai-rules/${id}/delete`, { method: 'POST' })
        .then(r => r.json()).then(d => { if(d.success) location.reload(); else alert('Failed'); });
}
</script>
{% endblock %}
