{% extends 'base.html' %}
{% block title %}Schedules - Sangrenes LMS{% endblock %}
{% block content %}
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
    <h1 style="font-size:1.2rem;font-weight:700;margin:0;"><i class="fas fa-calendar-alt" style="color:#F59E0B;"></i> Schedules</h1>
    <button onclick="openModal('addScheduleModal')" style="padding:8px 16px;border:none;border-radius:8px;background:var(--primary);color:white;font-size:0.82rem;font-weight:600;cursor:pointer;"><i class="fas fa-plus"></i> Add Schedule</button>
</div>

<div class="tab-bar">
    <button class="active" data-tab-btn="sch" onclick="switchTab('sch','tab-class')"><i class="fas fa-book-open"></i> Class Schedules</button>
    <button data-tab-btn="sch" onclick="switchTab('sch','tab-custom')"><i class="fas fa-calendar-plus"></i> Custom Schedules</button>
</div>

<!-- Class Schedules (from subjects) -->
<div id="tab-class" class="tab-panel active" data-tab-group="sch">
    <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;">
        {% if subject_schedules %}
        <div style="overflow-x:auto;">
            <table style="width:100%;border-collapse:collapse;">
                <thead><tr style="background:#F8FAFC;">
                    <th style="padding:10px 14px;text-align:left;font-size:0.78rem;color:var(--muted);">Subject</th>
                    <th style="padding:10px 14px;text-align:center;font-size:0.78rem;color:var(--muted);">Section</th>
                    <th style="padding:10px 14px;text-align:center;font-size:0.78rem;color:var(--muted);">Day</th>
                    <th style="padding:10px 14px;text-align:center;font-size:0.78rem;color:var(--muted);">Time</th>
                    <th style="padding:10px 14px;text-align:center;font-size:0.78rem;color:var(--muted);">Room</th>
                    <th style="padding:10px 14px;text-align:center;font-size:0.78rem;color:var(--muted);">Teacher</th>
                </tr></thead>
                <tbody>
                {% set day_colors = {'Monday':'#3B82F6','Tuesday':'#10B981','Wednesday':'#F59E0B','Thursday':'#8B5CF6','Friday':'#EF4444','Saturday':'#6366F1','Sunday':'#EC4899'} %}
                {% for s in subject_schedules %}
                <tr style="border-bottom:1px solid #F1F5F9;">
                    <td style="padding:10px 14px;"><div style="font-size:0.85rem;font-weight:600;">{{ s.code }}</div><div style="font-size:0.72rem;color:var(--muted);">{{ s.name }}</div></td>
                    <td style="padding:10px 14px;text-align:center;"><span style="background:var(--primary-light);color:var(--primary);padding:2px 10px;border-radius:12px;font-size:0.72rem;">{{ s.section }}</span></td>
                    <td style="padding:10px 14px;text-align:center;"><span style="background:{{ day_colors.get(s.day, '#64748B') }}22;color:{{ day_colors.get(s.day, '#64748B') }};padding:2px 10px;border-radius:12px;font-size:0.72rem;font-weight:600;">{{ s.day or '-' }}</span></td>
                    <td style="padding:10px 14px;text-align:center;font-size:0.82rem;">{{ s.time_schedule or '-' }}</td>
                    <td style="padding:10px 14px;text-align:center;font-size:0.82rem;color:var(--muted);">{{ s.room or '-' }}</td>
                    <td style="padding:10px 14px;text-align:center;font-size:0.82rem;">{{ s.instructor_name or 'Unassigned' }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="padding:50px;text-align:center;color:var(--muted);">No class schedules yet.</div>
        {% endif %}
    </div>
</div>

<!-- Custom Schedules -->
<div id="tab-custom" class="tab-panel" data-tab-group="sch">
    <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;">
        {% if schedules %}
        <div style="overflow-x:auto;">
            <table style="width:100%;border-collapse:collapse;">
                <thead><tr style="background:#F8FAFC;">
                    <th style="padding:10px 14px;text-align:left;font-size:0.78rem;color:var(--muted);">Title</th>
                    <th style="padding:10px 14px;text-align:center;font-size:0.78rem;color:var(--muted);">Day</th>
                    <th style="padding:10px 14px;text-align:center;font-size:0.78rem;color:var(--muted);">Time</th>
                    <th style="padding:10px 14px;text-align:center;font-size:0.78rem;color:var(--muted);">Room</th>
                    <th style="padding:10px 14px;text-align:center;font-size:0.78rem;color:var(--muted);">Subject</th>
                    <th style="padding:10px 14px;text-align:center;font-size:0.78rem;color:var(--muted);">Teacher</th>
                    <th style="padding:10px 14px;text-align:right;font-size:0.78rem;color:var(--muted);">Action</th>
                </tr></thead>
                <tbody>
                {% for s in schedules %}
                <tr style="border-bottom:1px solid #F1F5F9;">
                    <td style="padding:10px 14px;font-size:0.85rem;font-weight:600;">{{ s.title }}</td>
                    <td style="padding:10px 14px;text-align:center;font-size:0.82rem;">{{ s.day_of_week }}</td>
                    <td style="padding:10px 14px;text-align:center;font-size:0.82rem;">{{ s.start_time }} - {{ s.end_time }}</td>
                    <td style="padding:10px 14px;text-align:center;font-size:0.82rem;color:var(--muted);">{{ s.room or '-' }}</td>
                    <td style="padding:10px 14px;text-align:center;font-size:0.82rem;">{{ s.subject_code or '-' }}</td>
                    <td style="padding:10px 14px;text-align:center;font-size:0.82rem;">{{ s.instructor_name or '-' }}</td>
                    <td style="padding:10px 14px;text-align:right;">
                        <button onclick="deleteSch({{ s.id }})" style="padding:4px 10px;font-size:0.72rem;background:#FEE2E2;color:#991B1B;border:none;border-radius:6px;cursor:pointer;"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="padding:50px;text-align:center;color:var(--muted);">No custom schedules yet.</div>
        {% endif %}
    </div>
</div>

<!-- Add Schedule Modal -->
<div id="addScheduleModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;">
    <div style="background:white;border-radius:16px;padding:30px;max-width:500px;width:90%;margin:auto;position:relative;top:50%;transform:translateY(-50%);">
        <h3 style="margin:0 0 20px;"><i class="fas fa-calendar-plus" style="color:#F59E0B;"></i> Add Schedule</h3>
        <div style="display:flex;flex-direction:column;gap:12px;">
            <div><label style="font-size:0.8rem;color:var(--muted);">Title *</label><input type="text" id="schTitle" placeholder="e.g. Lab Session, Faculty Meeting" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;box-sizing:border-box;"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
                <div><label style="font-size:0.8rem;color:var(--muted);">Day *</label><select id="schDay" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option></select></div>
                <div><label style="font-size:0.8rem;color:var(--muted);">Start Time *</label><input type="time" id="schStart" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;box-sizing:border-box;"></div>
                <div><label style="font-size:0.8rem;color:var(--muted);">End Time *</label><input type="time" id="schEnd" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;box-sizing:border-box;"></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label style="font-size:0.8rem;color:var(--muted);">Subject</label><select id="schSubject" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;"><option value="">-- None --</option>{% for s in subjects %}<option value="{{ s.id }}">{{ s.code }} {{ s.section }}</option>{% endfor %}</select></div>
                <div><label style="font-size:0.8rem;color:var(--muted);">Teacher</label><select id="schTeacher" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;"><option value="">-- None --</option>{% for t in teachers %}<option value="{{ t.id }}">{{ t.full_name }}</option>{% endfor %}</select></div>
            </div>
            <div><label style="font-size:0.8rem;color:var(--muted);">Room</label><input type="text" id="schRoom" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;box-sizing:border-box;"></div>
        </div>
        <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end;">
            <button onclick="closeModal('addScheduleModal')" style="padding:8px 20px;border:1px solid var(--border);border-radius:8px;background:white;cursor:pointer;">Cancel</button>
            <button onclick="saveSch()" style="padding:8px 20px;border:none;border-radius:8px;background:var(--primary);color:white;cursor:pointer;font-weight:600;">Save</button>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
function saveSch() {
    const data = {
        title: document.getElementById('schTitle').value,
        day_of_week: document.getElementById('schDay').value,
        start_time: document.getElementById('schStart').value,
        end_time: document.getElementById('schEnd').value,
        subject_id: document.getElementById('schSubject').value || null,
        instructor_id: document.getElementById('schTeacher').value || null,
        room: document.getElementById('schRoom').value
    };
    fetch('/api/institution/schedules', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) })
        .then(r => r.json()).then(d => { if (d.success) location.reload(); else alert(d.error || 'Failed'); });
}
function deleteSch(id) {
    if (!confirm('Delete this schedule?')) return;
    fetch(`/api/institution/schedules/${id}`, { method: 'DELETE' })
        .then(r => r.json()).then(d => { if (d.success) location.reload(); });
}
</script>
{% endblock %}
