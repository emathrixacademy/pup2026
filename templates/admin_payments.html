{% extends 'base.html' %}

{% block title %}Payments & Tuition - Sangrenes LMS Portal{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1><i class="fas fa-money-bill-wave"></i> Payments & Tuition</h1>
        <p>Manage student payments, tuition fees, and billing</p>
    </div>
    <div style="display:flex;gap:10px;">
        <button class="btn btn-primary" onclick="openModal('addPaymentModal')"><i class="fas fa-plus"></i> Add Payment</button>
        <button class="btn btn-primary" style="background:#10B981;" onclick="openModal('addPlanModal')"><i class="fas fa-list-alt"></i> Add Tuition Plan</button>
    </div>
</div>

<!-- Financial Stats -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px;">
    <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.06);text-align:center;border-top:3px solid #3B82F6;">
        <div style="font-size:1.6rem;font-weight:700;color:#3B82F6;">P{{ "{:,.2f}".format(total_billed) }}</div>
        <div style="font-size:0.8rem;color:#64748B;">Total Billed</div>
    </div>
    <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.06);text-align:center;border-top:3px solid #10B981;">
        <div style="font-size:1.6rem;font-weight:700;color:#10B981;">P{{ "{:,.2f}".format(total_collected) }}</div>
        <div style="font-size:0.8rem;color:#64748B;">Total Collected</div>
    </div>
    <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.06);text-align:center;border-top:3px solid #F59E0B;">
        <div style="font-size:1.6rem;font-weight:700;color:#F59E0B;">P{{ "{:,.2f}".format(total_outstanding) }}</div>
        <div style="font-size:0.8rem;color:#64748B;">Outstanding</div>
    </div>
    <div style="background:white;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.06);text-align:center;border-top:3px solid #EF4444;">
        <div style="font-size:1.6rem;font-weight:700;color:#EF4444;">{{ overdue_count }}</div>
        <div style="font-size:0.8rem;color:#64748B;">Overdue</div>
    </div>
</div>

<!-- Tuition Plans -->
{% if tuition_plans %}
<div style="background:white;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06);overflow:hidden;margin-bottom:24px;">
    <div style="padding:16px 20px;border-bottom:1px solid #E2E8F0;">
        <h3 style="margin:0;font-size:1rem;"><i class="fas fa-list-alt" style="color:#8B5CF6;"></i> Tuition Plans</h3>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;padding:20px;">
        {% for tp in tuition_plans %}
        <div style="border:1px solid #E2E8F0;border-radius:10px;padding:20px;text-align:center;">
            <h4 style="margin:0 0 4px;color:#1E293B;">{{ tp.name }}</h4>
            <div style="font-size:0.8rem;color:#94A3B8;margin-bottom:10px;">{{ tp.institution_name or 'All Institutions' }} &middot; {{ tp.frequency }}</div>
            <div style="font-size:1.8rem;font-weight:700;color:#8B5CF6;">P{{ "{:,.0f}".format(tp.amount) }}</div>
            {% if tp.description %}<div style="font-size:0.8rem;color:#64748B;margin-top:8px;">{{ tp.description }}</div>{% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Payments Table -->
<div style="background:white;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06);overflow:hidden;">
    <div style="padding:16px 20px;border-bottom:1px solid #E2E8F0;">
        <h3 style="margin:0;font-size:1rem;"><i class="fas fa-receipt" style="color:#3B82F6;"></i> Payment Records ({{ payments|length }})</h3>
    </div>
    {% if payments %}
    <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;min-width:900px;">
            <thead>
                <tr style="background:#F8FAFC;">
                    <th style="padding:10px 14px;text-align:left;font-size:0.8rem;color:#64748B;">Student</th>
                    <th style="padding:10px 14px;text-align:center;font-size:0.8rem;color:#64748B;">Type</th>
                    <th style="padding:10px 14px;text-align:left;font-size:0.8rem;color:#64748B;">Description</th>
                    <th style="padding:10px 14px;text-align:right;font-size:0.8rem;color:#64748B;">Amount</th>
                    <th style="padding:10px 14px;text-align:right;font-size:0.8rem;color:#64748B;">Paid</th>
                    <th style="padding:10px 14px;text-align:right;font-size:0.8rem;color:#64748B;">Balance</th>
                    <th style="padding:10px 14px;text-align:center;font-size:0.8rem;color:#64748B;">Due Date</th>
                    <th style="padding:10px 14px;text-align:center;font-size:0.8rem;color:#64748B;">Status</th>
                    <th style="padding:10px 14px;text-align:right;font-size:0.8rem;color:#64748B;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for p in payments %}
                <tr style="border-bottom:1px solid #F1F5F9;">
                    <td style="padding:10px 14px;">
                        <div style="font-weight:600;font-size:0.85rem;">{{ p.full_name }}</div>
                        <div style="font-size:0.7rem;color:#94A3B8;">{{ p.sid or '' }} {{ p.section or '' }}</div>
                    </td>
                    <td style="padding:10px 14px;text-align:center;"><span style="background:#F1F5F9;color:#64748B;padding:2px 10px;border-radius:12px;font-size:0.75rem;">{{ p.payment_type }}</span></td>
                    <td style="padding:10px 14px;font-size:0.85rem;color:#64748B;">{{ p.description or '-' }}</td>
                    <td style="padding:10px 14px;text-align:right;font-weight:600;">P{{ "{:,.2f}".format(p.amount) }}</td>
                    <td style="padding:10px 14px;text-align:right;color:#10B981;font-weight:600;">P{{ "{:,.2f}".format(p.amount_paid or 0) }}</td>
                    <td style="padding:10px 14px;text-align:right;color:{% if p.balance > 0 %}#EF4444{% else %}#10B981{% endif %};font-weight:600;">P{{ "{:,.2f}".format(p.balance or 0) }}</td>
                    <td style="padding:10px 14px;text-align:center;font-size:0.85rem;color:#64748B;">{{ p.due_date or '-' }}</td>
                    <td style="padding:10px 14px;text-align:center;">
                        {% if p.status == 'paid' %}<span style="background:#D1FAE5;color:#065F46;padding:2px 10px;border-radius:12px;font-size:0.75rem;">Paid</span>
                        {% elif p.status == 'partial' %}<span style="background:#FEF3C7;color:#92400E;padding:2px 10px;border-radius:12px;font-size:0.75rem;">Partial</span>
                        {% elif p.status == 'overdue' %}<span style="background:#FEE2E2;color:#991B1B;padding:2px 10px;border-radius:12px;font-size:0.75rem;">Overdue</span>
                        {% else %}<span style="background:#DBEAFE;color:#1E40AF;padding:2px 10px;border-radius:12px;font-size:0.75rem;">Pending</span>{% endif %}
                    </td>
                    <td style="padding:10px 14px;text-align:right;">
                        {% if p.status != 'paid' %}
                        <button onclick="recordPayment({{ p.id }}, {{ p.balance or 0 }})" style="padding:4px 10px;font-size:0.75rem;background:#D1FAE5;color:#065F46;border:none;border-radius:6px;cursor:pointer;"><i class="fas fa-money-bill"></i> Pay</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="padding:60px;text-align:center;color:#94A3B8;">
        <i class="fas fa-file-invoice-dollar" style="font-size:3rem;margin-bottom:16px;color:#CBD5E1;"></i>
        <h3 style="color:#64748B;">No payment records yet</h3>
        <p>Create payment records for student tuition and fees.</p>
    </div>
    {% endif %}
</div>

<!-- Add Payment Modal -->
<div id="addPaymentModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;">
    <div style="background:white;border-radius:16px;padding:30px;max-width:500px;width:90%;margin:auto;position:relative;top:50%;transform:translateY(-50%);max-height:80vh;overflow-y:auto;">
        <h3 style="margin:0 0 20px;"><i class="fas fa-plus-circle" style="color:#3B82F6;"></i> Create Payment Record</h3>
        <div style="display:flex;flex-direction:column;gap:12px;">
            <div><label style="font-size:0.8rem;color:#64748B;">Student *</label>
                <select id="payStudent" style="padding:10px;border:1px solid #E2E8F0;border-radius:8px;width:100%;">
                    <option value="">-- Select Student --</option>
                    {% for s in students %}<option value="{{ s.id }}">{{ s.full_name }} ({{ s.student_id or s.id }})</option>{% endfor %}
                </select>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label style="font-size:0.8rem;color:#64748B;">Payment Type</label>
                    <select id="payType" style="padding:10px;border:1px solid #E2E8F0;border-radius:8px;width:100%;">
                        <option value="tuition">Tuition</option>
                        <option value="miscellaneous">Miscellaneous</option>
                        <option value="lab_fee">Lab Fee</option>
                        <option value="library">Library Fee</option>
                        <option value="id_fee">ID Fee</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div><label style="font-size:0.8rem;color:#64748B;">Amount (PHP) *</label><input type="number" id="payAmount" step="0.01" style="padding:10px;border:1px solid #E2E8F0;border-radius:8px;width:100%;box-sizing:border-box;"></div>
            </div>
            <div><label style="font-size:0.8rem;color:#64748B;">Description</label><input type="text" id="payDesc" placeholder="e.g., 1st Semester Tuition 2025-2026" style="padding:10px;border:1px solid #E2E8F0;border-radius:8px;width:100%;box-sizing:border-box;"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label style="font-size:0.8rem;color:#64748B;">Due Date</label><input type="date" id="payDue" style="padding:10px;border:1px solid #E2E8F0;border-radius:8px;width:100%;box-sizing:border-box;"></div>
                <div><label style="font-size:0.8rem;color:#64748B;">Institution</label>
                    <select id="payInst" style="padding:10px;border:1px solid #E2E8F0;border-radius:8px;width:100%;">
                        <option value="">-- N/A --</option>
                        {% for i in institutions %}<option value="{{ i.id }}">{{ i.short_name }}</option>{% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end;">
            <button onclick="closeModal('addPaymentModal')" style="padding:8px 20px;border:1px solid #E2E8F0;border-radius:8px;background:white;cursor:pointer;">Cancel</button>
            <button onclick="createPayment()" style="padding:8px 20px;border:none;border-radius:8px;background:#3B82F6;color:white;cursor:pointer;font-weight:600;">Create</button>
        </div>
    </div>
</div>

<!-- Record Payment Modal -->
<div id="payModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;">
    <div style="background:white;border-radius:16px;padding:30px;max-width:400px;width:90%;margin:auto;position:relative;top:50%;transform:translateY(-50%);">
        <h3 style="margin:0 0 20px;"><i class="fas fa-money-bill" style="color:#10B981;"></i> Record Payment</h3>
        <input type="hidden" id="payRecordId">
        <div style="display:flex;flex-direction:column;gap:12px;">
            <div><label style="font-size:0.8rem;color:#64748B;">Amount Paying (PHP)</label><input type="number" id="payRecordAmount" step="0.01" style="padding:10px;border:1px solid #E2E8F0;border-radius:8px;width:100%;box-sizing:border-box;"></div>
            <div><label style="font-size:0.8rem;color:#64748B;">Payment Method</label>
                <select id="payMethod" style="padding:10px;border:1px solid #E2E8F0;border-radius:8px;width:100%;">
                    <option value="cash">Cash</option>
                    <option value="gcash">GCash</option>
                    <option value="bank_transfer">Bank Transfer</option>
                    <option value="check">Check</option>
                    <option value="online">Online Payment</option>
                </select>
            </div>
            <div><label style="font-size:0.8rem;color:#64748B;">Reference Number</label><input type="text" id="payRef" style="padding:10px;border:1px solid #E2E8F0;border-radius:8px;width:100%;box-sizing:border-box;"></div>
        </div>
        <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end;">
            <button onclick="closeModal('payModal')" style="padding:8px 20px;border:1px solid #E2E8F0;border-radius:8px;background:white;cursor:pointer;">Cancel</button>
            <button onclick="submitPayment()" style="padding:8px 20px;border:none;border-radius:8px;background:#10B981;color:white;cursor:pointer;font-weight:600;">Submit Payment</button>
        </div>
    </div>
</div>

<!-- Add Tuition Plan Modal -->
<div id="addPlanModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;">
    <div style="background:white;border-radius:16px;padding:30px;max-width:450px;width:90%;margin:auto;position:relative;top:50%;transform:translateY(-50%);">
        <h3 style="margin:0 0 20px;"><i class="fas fa-list-alt" style="color:#8B5CF6;"></i> Add Tuition Plan</h3>
        <div style="display:flex;flex-direction:column;gap:12px;">
            <div><label style="font-size:0.8rem;color:#64748B;">Plan Name *</label><input type="text" id="planName" placeholder="e.g., Regular Tuition" style="padding:10px;border:1px solid #E2E8F0;border-radius:8px;width:100%;box-sizing:border-box;"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label style="font-size:0.8rem;color:#64748B;">Amount (PHP) *</label><input type="number" id="planAmount" step="0.01" style="padding:10px;border:1px solid #E2E8F0;border-radius:8px;width:100%;box-sizing:border-box;"></div>
                <div><label style="font-size:0.8rem;color:#64748B;">Frequency</label>
                    <select id="planFreq" style="padding:10px;border:1px solid #E2E8F0;border-radius:8px;width:100%;">
                        <option value="semester">Per Semester</option>
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                        <option value="one-time">One Time</option>
                    </select>
                </div>
            </div>
            <div><label style="font-size:0.8rem;color:#64748B;">Institution</label>
                <select id="planInst" style="padding:10px;border:1px solid #E2E8F0;border-radius:8px;width:100%;">
                    <option value="">-- All Institutions --</option>
                    {% for i in institutions %}<option value="{{ i.id }}">{{ i.short_name }}</option>{% endfor %}
                </select>
            </div>
            <div><label style="font-size:0.8rem;color:#64748B;">Description</label><input type="text" id="planDesc" style="padding:10px;border:1px solid #E2E8F0;border-radius:8px;width:100%;box-sizing:border-box;"></div>
        </div>
        <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end;">
            <button onclick="closeModal('addPlanModal')" style="padding:8px 20px;border:1px solid #E2E8F0;border-radius:8px;background:white;cursor:pointer;">Cancel</button>
            <button onclick="createPlan()" style="padding:8px 20px;border:none;border-radius:8px;background:#8B5CF6;color:white;cursor:pointer;font-weight:600;">Create Plan</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function createPayment() {
    fetch('/api/admin/payments', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            student_id: document.getElementById('payStudent').value,
            payment_type: document.getElementById('payType').value,
            amount: parseFloat(document.getElementById('payAmount').value),
            description: document.getElementById('payDesc').value,
            due_date: document.getElementById('payDue').value,
            institution_id: document.getElementById('payInst').value || null
        })
    }).then(r => r.json()).then(d => { if (d.success) location.reload(); else alert(d.error || 'Failed'); });
}
function recordPayment(id, balance) {
    document.getElementById('payRecordId').value = id;
    document.getElementById('payRecordAmount').value = balance;
    openModal('payModal');
}
function submitPayment() {
    const id = document.getElementById('payRecordId').value;
    fetch(`/api/admin/payments/${id}/pay`, {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            amount_paid: parseFloat(document.getElementById('payRecordAmount').value),
            payment_method: document.getElementById('payMethod').value,
            reference_number: document.getElementById('payRef').value
        })
    }).then(r => r.json()).then(d => { if (d.success) location.reload(); else alert(d.error || 'Failed'); });
}
function createPlan() {
    fetch('/api/admin/tuition-plans', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            name: document.getElementById('planName').value,
            amount: parseFloat(document.getElementById('planAmount').value),
            frequency: document.getElementById('planFreq').value,
            institution_id: document.getElementById('planInst').value || null,
            description: document.getElementById('planDesc').value
        })
    }).then(r => r.json()).then(d => { if (d.success) location.reload(); else alert(d.error || 'Failed'); });
}
</script>
{% endblock %}
