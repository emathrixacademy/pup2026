{% extends 'base.html' %}
{% block title %}My Subjects - eMathrix LMS{% endblock %}
{% block content %}
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
    <h1 style="font-size:1.2rem;font-weight:700;margin:0;"><i class="fas fa-book-open" style="color:var(--primary);"></i> My Subjects</h1>
    <button onclick="document.getElementById('editSubId').value='';openModal('addSubModal')" style="padding:8px 16px;border:none;border-radius:8px;background:var(--primary);color:white;font-size:0.82rem;font-weight:600;cursor:pointer;"><i class="fas fa-plus"></i> Add Subject</button>
</div>

<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;">
    {% set colors = ['#6366F1','#10B981','#8B5CF6','#F59E0B','#EF4444','#3B82F6'] %}
    {% for s in subjects %}
    <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;">
        <div style="background:{{ colors[loop.index0 % 6] }};padding:16px 18px;color:white;">
            <div style="font-size:1.05rem;font-weight:700;">{{ s.code }}</div>
            <div style="font-size:0.82rem;opacity:0.9;">{{ s.name }}</div>
            <div style="font-size:0.72rem;opacity:0.8;margin-top:4px;">{{ s.section }} &middot; {{ s.day or '' }} {{ s.time_schedule or '' }}</div>
        </div>
        <div style="padding:14px 18px;">
            <div style="font-size:0.78rem;color:var(--muted);margin-bottom:10px;">
                <i class="fas fa-users"></i> {{ s.enrolled }} enrolled &middot; <i class="fas fa-book"></i> {{ s.session_count }} sessions
                {% if s.room %} &middot; <i class="fas fa-door-open"></i> {{ s.room }}{% endif %}
            </div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;">
                <a href="{{ url_for('subject_detail', id=s.id) }}" style="padding:5px 12px;font-size:0.72rem;background:var(--primary-light);color:var(--primary);border-radius:6px;text-decoration:none;font-weight:500;"><i class="fas fa-folder-open"></i> Sessions</a>
                <button onclick='editMySub({{ s|tojson }})' style="padding:5px 12px;font-size:0.72rem;background:#DBEAFE;color:#1E40AF;border:none;border-radius:6px;cursor:pointer;"><i class="fas fa-edit"></i> Edit</button>
                <button onclick="deleteMySub({{ s.id }})" style="padding:5px 12px;font-size:0.72rem;background:#FEE2E2;color:#991B1B;border:none;border-radius:6px;cursor:pointer;"><i class="fas fa-trash"></i></button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% if not subjects %}
<div style="padding:60px;text-align:center;color:var(--muted);background:var(--card);border:1px solid var(--border);border-radius:12px;">
    <i class="fas fa-book-open" style="font-size:2.5rem;color:#CBD5E1;margin-bottom:12px;display:block;"></i>
    <div style="font-size:0.92rem;">No subjects yet. Create your first subject.</div>
</div>
{% endif %}

<!-- Add/Edit Subject Modal -->
<div id="addSubModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;">
    <div style="background:white;border-radius:16px;padding:30px;max-width:500px;width:90%;margin:auto;position:relative;top:50%;transform:translateY(-50%);">
        <h3 style="margin:0 0 20px;" id="mySubTitle"><i class="fas fa-plus-circle" style="color:var(--primary);"></i> Add Subject</h3>
        <input type="hidden" id="editSubId">
        <div style="display:flex;flex-direction:column;gap:12px;">
            <div style="display:grid;grid-template-columns:1fr 2fr;gap:10px;">
                <div><label style="font-size:0.8rem;color:var(--muted);">Code *</label><input type="text" id="mySubCode" placeholder="COMP019" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;box-sizing:border-box;"></div>
                <div><label style="font-size:0.8rem;color:var(--muted);">Name *</label><input type="text" id="mySubName" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;box-sizing:border-box;"></div>
            </div>
            <div><label style="font-size:0.8rem;color:var(--muted);">Description</label><input type="text" id="mySubDesc" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;box-sizing:border-box;"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label style="font-size:0.8rem;color:var(--muted);">Section</label><input type="text" id="mySubSection" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;box-sizing:border-box;"></div>
                <div><label style="font-size:0.8rem;color:var(--muted);">Room</label><input type="text" id="mySubRoom" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;box-sizing:border-box;"></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label style="font-size:0.8rem;color:var(--muted);">Day</label><select id="mySubDay" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;"><option value="">--</option><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option></select></div>
                <div><label style="font-size:0.8rem;color:var(--muted);">Time</label><input type="text" id="mySubTime" placeholder="1:00PM-6:00PM" style="padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;box-sizing:border-box;"></div>
            </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end;">
            <button onclick="closeModal('addSubModal')" style="padding:8px 20px;border:1px solid var(--border);border-radius:8px;background:white;cursor:pointer;">Cancel</button>
            <button onclick="saveMySub()" style="padding:8px 20px;border:none;border-radius:8px;background:var(--primary);color:white;cursor:pointer;font-weight:600;">Save</button>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
function editMySub(s) {
    document.getElementById('editSubId').value = s.id;
    document.getElementById('mySubTitle').innerHTML = '<i class="fas fa-edit" style="color:var(--primary);"></i> Edit Subject';
    document.getElementById('mySubCode').value = s.code || '';
    document.getElementById('mySubName').value = s.name || '';
    document.getElementById('mySubDesc').value = s.description || '';
    document.getElementById('mySubSection').value = s.section || '';
    document.getElementById('mySubRoom').value = s.room || '';
    document.getElementById('mySubDay').value = s.day || '';
    document.getElementById('mySubTime').value = s.time_schedule || '';
    openModal('addSubModal');
}
function saveMySub() {
    const id = document.getElementById('editSubId').value;
    const data = {
        code: document.getElementById('mySubCode').value,
        name: document.getElementById('mySubName').value,
        description: document.getElementById('mySubDesc').value,
        section: document.getElementById('mySubSection').value,
        room: document.getElementById('mySubRoom').value,
        day: document.getElementById('mySubDay').value,
        time_schedule: document.getElementById('mySubTime').value
    };
    const url = id ? `/api/instructor/subjects/${id}` : '/api/instructor/subjects';
    fetch(url, { method: id ? 'PUT' : 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) })
        .then(r => r.json()).then(d => { if (d.success) location.reload(); else alert(d.error || 'Failed'); });
}
function deleteMySub(id) {
    if (!confirm('Delete this subject and all sessions?')) return;
    fetch(`/api/instructor/subjects/${id}`, { method: 'DELETE' })
        .then(r => r.json()).then(d => { if (d.success) location.reload(); });
}
</script>
{% endblock %}
