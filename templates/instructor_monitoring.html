{% extends 'base.html' %}

{% block title %}Student Performance Monitoring{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1><i class="fas fa-heartbeat"></i> Student Performance Monitoring</h1>
        <p style="color: #64748B;">Track at-risk students, send reminders, and provide guidance</p>
    </div>
    <div class="flex gap-10">
        <button class="btn btn-warning" onclick="sendAllReminders()" id="btnRemind">
            <i class="fas fa-bell"></i> Send All Reminders
        </button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back
        </a>
    </div>
</div>

<!-- Stats Grid -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 1.5rem;">
    <div style="background: white; border-radius: 12px; padding: 1.25rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #EF4444;">
        <div style="font-size: 2rem; font-weight: 700; color: #EF4444;">{{ at_risk_students|length }}</div>
        <div style="font-size: 0.85rem; color: #64748B;"><i class="fas fa-exclamation-circle"></i> At-Risk Students</div>
    </div>
    <div style="background: white; border-radius: 12px; padding: 1.25rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #F59E0B;">
        <div style="font-size: 2rem; font-weight: 700; color: #F59E0B;">{{ missed_deadline_count }}</div>
        <div style="font-size: 0.85rem; color: #64748B;"><i class="fas fa-clock"></i> Missed Deadlines</div>
    </div>
    <div style="background: white; border-radius: 12px; padding: 1.25rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #8B5CF6;">
        <div style="font-size: 2rem; font-weight: 700; color: #8B5CF6;">{{ low_grade_count }}</div>
        <div style="font-size: 0.85rem; color: #64748B;"><i class="fas fa-chart-line"></i> Low Grades</div>
    </div>
    <div style="background: white; border-radius: 12px; padding: 1.25rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #3B82F6;">
        <div style="font-size: 2rem; font-weight: 700; color: #3B82F6;">{{ behind_count }}</div>
        <div style="font-size: 0.85rem; color: #64748B;"><i class="fas fa-tasks"></i> Behind on Lessons</div>
    </div>
    <div style="background: white; border-radius: 12px; padding: 1.25rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #10B981;">
        <div style="font-size: 2rem; font-weight: 700; color: #10B981;">{{ alerts_sent }}</div>
        <div style="font-size: 0.85rem; color: #64748B;"><i class="fas fa-paper-plane"></i> Alerts Sent</div>
    </div>
</div>

<!-- Filter Bar -->
<div class="card" style="margin-bottom: 1.25rem;">
    <div class="card-body" style="padding: 0.75rem 1.25rem;">
        <form method="GET" style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
            <label style="font-size: 0.85rem; font-weight: 600; color: #475569;"><i class="fas fa-filter"></i> Filter by Subject:</label>
            <select name="subject_id" onchange="this.form.submit()" style="padding: 6px 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.85rem;">
                <option value="">All Subjects</option>
                {% for s in subjects %}
                <option value="{{ s.id }}" {% if filter_subject == s.id %}selected{% endif %}>{{ s.code }} - {{ s.section }}</option>
                {% endfor %}
            </select>
            <span style="font-size: 0.85rem; color: #64748B;">Showing {{ at_risk_students|length }} student(s) with issues</span>
        </form>
    </div>
</div>

{% if at_risk_students|length == 0 %}
<div class="card">
    <div class="card-body" style="text-align: center; padding: 3rem;">
        <i class="fas fa-check-circle" style="font-size: 3rem; color: #10B981; margin-bottom: 1rem;"></i>
        <h3 style="color: #475569;">All Students On Track!</h3>
        <p style="color: #94A3B8;">No at-risk students detected. Everyone is up to date with their lessons and submissions.</p>
    </div>
</div>
{% else %}

<!-- At-Risk Students List -->
<div style="display: flex; flex-direction: column; gap: 12px;">
    {% for item in at_risk_students %}
    <div class="card" style="overflow: hidden; border-left: 4px solid {{ '#EF4444' if item.max_severity == 'critical' else '#F59E0B' }};">
        <div class="card-body" style="padding: 1rem 1.25rem;">
            <div style="display: flex; align-items: flex-start; gap: 16px; flex-wrap: wrap;">
                <!-- Student Info -->
                <div style="display: flex; align-items: center; gap: 12px; min-width: 220px;">
                    <img src="/static/uploads/photos/{{ item.student.photo or 'default.png' }}"
                         style="width: 44px; height: 44px; border-radius: 50%; object-fit: cover; border: 3px solid {{ '#EF4444' if item.max_severity == 'critical' else '#F59E0B' }};"
                         onerror="this.src='/static/uploads/photos/default.png'">
                    <div>
                        <div style="font-weight: 600; color: #1E293B; font-size: 0.95rem;">{{ item.student.full_name }}</div>
                        <div style="font-size: 0.8rem; color: #64748B;">{{ item.student.student_id or 'N/A' }} &middot; {{ item.student.section or '' }}</div>
                    </div>
                </div>

                <!-- Subject Badge -->
                <div style="display: flex; align-items: center;">
                    <span style="background: #EDE9FE; color: #6D28D9; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                        {{ item.subject.code }} - {{ item.subject.section }}
                    </span>
                </div>

                <!-- Grade Badge -->
                <div style="display: flex; align-items: center;">
                    {% if item.weighted_grade > 0 %}
                    <span style="background: {{ '#FEE2E2' if item.weighted_grade < 75 else ('#FEF3C7' if item.weighted_grade < 82 else '#D1FAE5') }};
                                 color: {{ '#991B1B' if item.weighted_grade < 75 else ('#92400E' if item.weighted_grade < 82 else '#065F46') }};
                                 padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">
                        {{ '%.1f'|format(item.weighted_grade) }}%
                    </span>
                    {% endif %}
                </div>

                <!-- Issues -->
                <div style="flex: 1; display: flex; flex-wrap: wrap; gap: 6px; min-width: 200px;">
                    {% for issue in item.issues %}
                    <span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 6px; font-size: 0.78rem; font-weight: 500;
                                 background: {{ '#FEE2E2' if issue.severity == 'critical' else '#FEF3C7' }};
                                 color: {{ '#991B1B' if issue.severity == 'critical' else '#92400E' }};">
                        <i class="fas fa-{{ issue.icon }}"></i> {{ issue.message }}
                    </span>
                    {% endfor %}
                </div>

                <!-- Actions -->
                <div style="display: flex; gap: 6px; align-items: center;">
                    <button class="btn btn-sm btn-primary" onclick="sendGuidance({{ item.student.id }}, {{ item.subject.id }})" title="Send smart guidance">
                        <i class="fas fa-lightbulb"></i> Guide
                    </button>
                    <a href="{{ url_for('student_grades', student_id=item.student.id) }}?subject_id={{ item.subject.id }}" class="btn btn-sm btn-secondary" title="View grades">
                        <i class="fas fa-chart-bar"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
async function sendAllReminders() {
    var subjectFilter = new URLSearchParams(window.location.search).get('subject_id');
    if (!confirm('Send performance reminders to all at-risk students' + (subjectFilter ? ' in this subject' : '') + '? They will receive notifications.')) return;
    var btn = document.getElementById('btnRemind');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    try {
        var body = {};
        if (subjectFilter) body.subject_id = parseInt(subjectFilter);
        var r = await fetch('/api/monitoring/send-reminders', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
        });
        var d = await r.json();
        if (d.success) {
            alert(d.notifications_sent + ' reminder(s) sent to students!');
            location.reload();
        } else {
            alert(d.error || 'Error sending reminders');
        }
    } catch(e) { alert('Error: ' + e.message); }
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-bell"></i> Send All Reminders';
}

async function sendGuidance(studentId, subjectId) {
    try {
        var r = await fetch('/api/monitoring/send-guidance', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ student_id: studentId, subject_id: subjectId })
        });
        var d = await r.json();
        if (d.success) {
            alert('Guidance sent: ' + d.message);
        } else {
            alert(d.error || 'Error sending guidance');
        }
    } catch(e) { alert('Error: ' + e.message); }
}
</script>
{% endblock %}
